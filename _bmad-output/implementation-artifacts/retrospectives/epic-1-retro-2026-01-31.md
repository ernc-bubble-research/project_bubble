# Epic 1 Retrospective: Tenant Management & Platform Setup

**Date:** 2026-01-31
**Epic:** Epic 1 — Tenant Management & Platform Setup
**Status:** Complete (10/12 stories done, 1 skipped, 1 deferred)
**Facilitator:** Bob (Scrum Master)

## Participants

- Alice (Product Owner)
- Bob (Scrum Master) — facilitating
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- erinc (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Stories Completed:** 10/12 (100% of in-scope)
  - Done: 1.1, 1.2, 1.3, 1.4, 1.5, 1.7, 1.8, 1.9, 1.10, 1.12
  - Skipped: 1.6 (Tenant Seeding — FR51 obsoleted by workflow-centric visibility)
  - Deferred: 1.11 (CI/CD — moved to post-MVP, BMAD workflow covers lint/test/build)
- **Test count growth:** 13 (Story 1.2) → 219 (Story 1.12) — 16x growth
- **Code review issues found & fixed:** ~40 across all stories (3-7 per story)

### Quality

- All 219 tests passing (98 api-gateway + 110 web + 11 db-layer)
- Both lints clean, both builds green
- Zero production incidents
- RLS enforcement fully operational with 10 PostgreSQL policies

### Business Outcomes

- Full tenant lifecycle: provisioning → configuration → impersonation → user management → invitations
- Authentication & authorization: JWT + RBAC + RLS
- Admin dashboard (The Lobby) with all management UIs
- Auth UI: login + set-password pages
- Email-based invitation flow with secure token handling

---

## What Went Well

### Strong Foundation Patterns

- **RLS architecture (Story 1.8)** was the breakthrough — `TransactionManager` + `SET LOCAL app.current_tenant` + `FORCE ROW LEVEL SECURITY` enforces tenant isolation at the database level. Every subsequent story benefited.
- **Shared DTO pattern** between frontend and backend maintained contract consistency from Day 1.
- **Standalone Angular components with Signals** established a clean, modern frontend architecture.
- **Module boundary enforcement** via Nx tags prevented cross-scope imports.

### Code Review Discipline

- Every story went through adversarial code review (3-7 findings each).
- Security-critical catches: SQL injection in RLS setup, O(n) bcrypt scan, missing RLS policies for INSERT/UPDATE, Observable memory leaks.
- Quality improved story-over-story as patterns solidified.

### Scope Management

- Skipping 1.6 (tenant seeding) and deferring 1.11 (CI/CD) were correct calls that kept focus tight.
- BMAD workflow provided equivalent build/test/lint verification without CI/CD infrastructure.

### Team Collaboration

- Implement-then-review cycle proved highly effective.
- Pattern reuse accelerated later stories (by Story 1.10, new features followed established rails).
- Project Lead (erinc) expressed high satisfaction with teamwork and bug-catching process.

---

## Challenges & Growth Areas

### RLS Exemption Complexity

- Stories 1.7–1.12 all dealt with tension between "enforce tenant isolation" and "auth flows need cross-tenant access."
- Resulted in 4 permissive policies + documented exemption table in project-context.md.
- Each new exemption requires careful security review.

### Recurring Code Review Findings

- **Missing input validation** appeared in multiple stories.
- **RLS policy gaps** discovered during review (e.g., missing INSERT/UPDATE policies for invitation accept flow).
- **Data integrity issues** like `name` vs `inviterName` mix-up in Story 1.12.
- Pattern: issues are being introduced then caught, rather than prevented up-front.

### Framework Pattern Mismatches

- **Angular `inject()` vs constructor DI**: Story 1.12 hit the `@angular-eslint/prefer-inject` lint rule. NestJS uses constructor DI, Angular prefers `inject()` — context-switching cost.
- **Circular dependencies**: `forwardRef()` needed between AuthModule and InvitationsModule.

### Minor Technical Debt

- Budget warning on `tenant-detail.component.scss` (6.50 kB vs 4.00 kB budget).
- Pre-existing lint warning in `login.component.spec.ts`.

---

## Key Insights & Learnings

1. **Code review catches real security issues** — The adversarial review process is not optional; it found production-grade vulnerabilities in every story.
2. **Pattern establishment pays compound dividends** — Investment in Stories 1.1–1.3 (monorepo, entities, routing) dramatically accelerated Stories 1.7–1.12.
3. **RLS exemptions need disciplined tracking** — Cross-tenant access is necessary for auth flows but each exemption expands the attack surface. Document and review every one.
4. **Harden before you scale** — Running security and test assessments before Epic 2 prevents building on hidden weaknesses.

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | Run NFR Security Assessment (`testarch-nfr`) | Charlie + Dana | All OWASP findings documented, critical issues fixed before Epic 2 |
| 2 | Run Test Quality Review (`testarch-test-review`) | Dana | Coverage gaps identified, missing edge-case tests added |
| 3 | Establish RLS exemption review process | Charlie | project-context.md exemption table always current |

### Technical Debt

| # | Item | Owner | Priority |
|---|------|-------|----------|
| 1 | Budget warning on tenant-detail.component.scss | Elena | Low |
| 2 | Pre-existing lint warning in login.component.spec.ts | Elena | Low |

### Team Agreements

- Always use `inject()` pattern in Angular (not constructor DI)
- Every new entity table with `tenant_id` must be added to `tenantScopedTables` in RLS setup
- Code review is mandatory before any story is marked "done"

---

## Epic 2 Preparation

### Critical (before Epic 2 starts)

- [ ] Run `/bmad:bmm:workflows:testarch-nfr` — security & reliability assessment
- [ ] Run `/bmad:bmm:workflows:testarch-test-review` — test quality validation
- [ ] Fix any critical/high findings from both assessments

### Knowledge Gaps

- [ ] pgvector — embedding storage and similarity search patterns
- [ ] BullMQ — job queue architecture for async file processing
- [ ] Text extraction — PDF/DOCX parsing (pdf-parse, mammoth)
- [ ] Chunking strategies — document splitting for effective RAG

### Dependencies on Epic 1

All dependencies met and stable:
- TenantEntity, UserEntity, InvitationEntity — complete
- RLS enforcement with TransactionManager — operational
- Auth + RBAC with JWT guards — functional
- Module boundary patterns (Nx tags, shared DTOs) — established
- Frontend 3-zone routing, standalone components, Signals — in place

---

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | PASS (pending assessments) | 219 tests, all green. NFR + test review to run. |
| Deployment | N/A (pre-production) | `synchronize:true` for dev. Migrations deferred to production. |
| Stakeholder Acceptance | PASS | erinc confirms satisfaction. |
| Technical Health | PASS | Stable foundation. No known regressions. |
| Unresolved Blockers | NONE | — |

---

## Next Steps

1. **Run `/bmad:bmm:workflows:testarch-nfr`** — security assessment on Epic 1 codebase
2. **Run `/bmad:bmm:workflows:testarch-test-review`** — test quality validation
3. **Fix critical findings** from both assessments
4. **Begin Epic 2** — create Story 2.1 with `/bmad:bmm:workflows:create-story`

---

*Epic 1 delivered 10 stories with 219 tests, established production-grade patterns for RLS, auth, and tenant management, and surfaced 4 key insights. The team is well-positioned for Epic 2 success after completing the security and test assessments.*
