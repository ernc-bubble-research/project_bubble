# Epic 3 Retrospective: Workflow Definition

**Date:** 2026-02-08
**Epic:** Epic 3 — Workflow Definition (Atomic Workflows, Chains, Wizard)
**Status:** Complete (12/12 core stories + Epic 3.1 + hardening + E2E + tenant lifecycle = 21 deliverables)
**Facilitator:** Bob (Scrum Master)
**Format:** Interactive party mode session with full team participation

## Participants

- Alice (Product Owner)
- Bob (Scrum Master) — facilitating
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- erinc (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Core Stories Completed:** 12/12 (100%)
  - 3-1 (Data Foundation), 3-2 (Wizard UI), 3-3 (Template CRUD), 3-4 (Versioning/Publishing),
  - 3-5 (Visibility/Access), 3-6a (Chain API), 3-6b (Chain Builder UI), 3-7 (Template Library),
  - 3-8 (Management View), 3-9 (Wizard Tooltips), 3-10 (File Type Presets), 3H (RxJS Hardening)
- **Epic 3.1 (Settings & Essentials):** 4/4 stories done
  - 3.1-1 (Settings Shell), 3.1-2 (Avatar Dropdown), 3.1-3 (LLM Model Admin UI), 3.1-4 (Provider Credential Storage)
- **Additional Stories:** 3E (E2E Tests), 1-13 (Tenant Lifecycle), 1E (E2E Framework), 2E (Data E2E)
- **Test count growth:** 406 (Epic 2 end) → 944 (current) — **133% growth (+538 tests)**
- **Code review findings fixed:** ~90+ across all stories
- **0 lint errors, 0 lint warnings** across all projects

### Quality

- 944 total tests passing (429 backend + 451 frontend + 64 shared/db-layer)
- 0 lint errors across all 4 projects
- 0 lint warnings across all 4 projects
- All stories had adversarial code review with findings presented to user
- E2E test framework established with 21 tests across 10 spec files
- ESLint RxJS subscription rule installed — prevents future memory leaks

### Business Outcomes

| Feature | Delivered |
|---------|-----------|
| Workflow Wizard | 6-step form builder producing YAML workflow definitions |
| Template CRUD | Create, read, update, delete workflow templates with metadata |
| Versioning & Publishing | Version history, publish/unpublish, deprecation |
| Visibility & Access Control | Public, private, restricted + allowed_tenants |
| Workflow Chains | Chain CRUD API + visual builder UI with ordering |
| Template Library | Card grid with search, filter by category/tags/status |
| Management View | Settings modal for visibility, tenants, archive/unarchive |
| Wizard Documentation | 12 contextual tooltips explaining wizard fields |
| File Type Presets | Chip-toggle UI for common file type groups |
| Admin Settings | Tabbed settings page (LLM Models, Providers, System) |
| Avatar Dropdown | User avatar menu with profile info + logout |
| LLM Model Admin | CRUD for system-wide LLM models |
| Provider Credentials | AES-256-GCM encrypted credential storage + CRUD API |
| Tenant Lifecycle | Archive/unarchive/hard-delete + TenantStatusGuard |
| E2E Framework | Playwright-based tests with auth fixtures, test DB lifecycle |

### Technical Foundation Built

| Capability | Implementation |
|-----------|---------------|
| Workflow YAML Schema | Tech spec with 12 tasks, 13 ACs, 20 decisions — contract between Epic 3 & 4 |
| Atomic Workflows | Single-prompt definitions with input role taxonomy (subject vs context) |
| Workflow Chains | Ordered composition of atomic workflows with input/output mappings |
| Signal-based State | Angular signals + computed properties throughout all new components |
| TenantStatusGuard | Controller-level guard blocking suspended/archived tenant access |
| Encrypted Credentials | AES-256-GCM with SETTINGS_ENCRYPTION_KEY for provider secrets |
| RxJS Subscription Safety | ESLint rule + `takeUntilDestroyed()` pattern enforced |
| E2E Infrastructure | Playwright + ephemeral test DB + API-level auth + hybrid seed |

---

## Epic 2 Retro Action Item Follow-Through

| # | Epic 2 Action Item | Status | Evidence |
|---|-------------------|--------|----------|
| 1 | Eliminate "acceptable for MVP" filter | ✅ Maintained | Zero instances of MVP-softened findings across all 21 Epic 3 deliverables. erinc confirmed: "I didn't hear that this is an MVP anyways let's degrade quality." |
| 2 | Code review presents findings before fixing | ✅ Maintained | Every story shows findings table → user decision → fix/defer/dismiss |
| 3 | Report ALL metrics on every test run | ✅ Maintained | Every story reports tests per project + lint errors + lint warnings |
| 4 | Quality gates are PASS/FAIL only | ✅ Maintained | No "CONCERNS with deferred recommendations" anywhere in Epic 3 |

**All 4 process corrections from Epic 2 were maintained throughout Epic 3 (21 deliverables).** This is a genuine team improvement. Process corrections stick when codified as rules and enforced by tooling.

### Epic 2 Technical Debt Items

| # | Item | Status | Notes |
|---|------|--------|-------|
| 1 | Swagger @ApiResponse gap fix | ✅ Completed | Gate requirement — done before Epic 3 started |
| 2 | Defense-in-depth tenantId in raw SQL | ⏳ In Progress | Rule added to project-context.md. Applied in new code. Legacy queries deferred to Epic 7. Automated check to be added before Epic 4 (Action Item 5). |

---

## What Went Well

### 1. Process Discipline Restored
All 4 Epic 2 process corrections were maintained throughout the largest epic to date (21 deliverables). The MVP excuse was permanently banned. Quality gates operated at production standard consistently. erinc acknowledged: "I didn't hear that this is an MVP anyways let's degrade quality. So thank you team for that."

### 2. Architectural Pivot Handled Cleanly
Rewriting all Epic 3 stories from node-graph to atomic workflow architecture (2026-02-02) was a massive course correction. The party mode discussion format enabled clear decision-making. The new architecture is simpler, more testable, and better aligned with the LLM-orchestrated execution model.

### 3. Tech Spec Gate Prevented Rework
The workflow definition schema tech spec (12 tasks, 13 ACs, 20 technical decisions) established the YAML contract between Epic 3 (producer) and Epic 4 (consumer) BEFORE any code was written. This eliminated the risk of building a UI that produces definitions the engine can't consume.

### 4. Massive Test Growth
406 → 944 tests (+133%) with zero lint errors. Every story added meaningful coverage. The test-per-story average was ~25, indicating consistent quality.

### 5. E2E Test Framework Established
21 E2E tests across 3 epics catch an entirely different class of bugs: entity registration, route resolution, icon registration, guard execution order. This infrastructure is now available for all future epics.

### 6. User Testing Feedback Loop
Hands-on browser testing generated real user feedback that directly produced stories (3.10 file type presets, 4.7 test run preview) and bug fixes (20 Lucide icons, tenant_id mismatch, SET LOCAL parameterization). erinc noted: "My initial testing of the interface showed it is promising. I feel we are on the right track."

### 7. Code Review Caught Critical Bugs
- TenantStatusGuard no-op (zero protection for tenant routes!)
- TenantId omissions in WHERE clauses (3 stories)
- 37 RxJS subscription leaks across 19 files
- FormsModule unused imports
- Missing data-testid attributes

---

## What Went Poorly / Challenges

### 1. Story 3.2 Was Too Large
The 6-step wizard with all UI components was at least 3 stories worth of work crammed into one. This led to:
- Multiple runtime bugs discovered only during hands-on UI testing
- Tags comma bug (NgOnChanges round-trip stripping commas)
- Markdown output sections error (missing formArrayName)
- Step validation bypassed (nextStep(true) hardcoded)
- Extended review cycle (17 code review fixes)

**Action:** Enforce story size limit — max ~60 tests per story. Split during planning party mode if exceeded.

### 2. Quality Regression in Story Creation (3.6b)
Despite Epic 2 corrections, the SM/Dev agent showed quality regression during story creation:
- Route inconsistency (specified `/admin/workflow-studio/chains/new` but existing routes use `/admin/workflows/`)
- Interface mismatch (input source options didn't match actual ChainInputSource interface)
- Missing dependencies (required WorkflowTemplateService.getAll() which didn't exist)
- Shallow analysis on deferral recommendations

Root cause: Agent optimizing for speed over correctness. Story creation becoming a checkbox exercise rather than thorough technical analysis.

**Action:** Story creation must verify actual codebase (routes, interfaces, services, DTOs). Planning party mode is the enforcement mechanism.

### 3. NestJS Guard Architecture Misunderstanding
TenantStatusGuard was registered as APP_GUARD but ran BEFORE JwtAuthGuard (which is controller-level). `request.user` was always undefined, making the guard a complete no-op with zero protection. This was a fundamental misunderstanding of NestJS guard execution order:
- APP_GUARD (global) → controller @UseGuards → route guards
- Fix: Moved to controller-level `@UseGuards(JwtAuthGuard, TenantStatusGuard, RolesGuard)`

**Action:** Guard ordering documentation required for every guard. TenantStatusGuard regression test in Story 4E.

### 4. Unit Tests Mock Everything — App Crashed Despite 555+ Tests Passing
This was erinc's biggest frustration: "We had so many unit tests which I was proud of and hoping we were building a solid codebase, yet it didn't even run and crashed."

Bugs invisible to unit tests:
- TypeORM entities not registered via forFeature()
- RlsSetupService crashing on missing tables
- Circular dependency in lazy routes
- 20 Lucide icons not registered (silently broke template rendering)

None of this was caught by unit tests because they mock all dependencies.

**Action:** Add module wiring / integration tests — NestJS module compilation tests (real providers, verify `.compile()` succeeds) and Angular component integration tests (real child components for critical paths). This becomes a standard test category for all future epics.

### 5. Recurring TenantId Omission
Despite being flagged in Epic 2 and added as a rule in project-context.md, the dev agent continued omitting tenantId from WHERE clauses in Stories 3.3, 3.4. Code review catches it every time, but prevention > detection.

**Action:** BOTH automated grep/CI check AND code review checklist item. Automated check implemented before Epic 4 starts — not deferred.

---

## Key Insights & Learnings

1. **Unit tests are necessary but not sufficient.** E2E tests catch entity registration, route resolution, icon registration, guard execution order — bugs invisible to mocked unit tests. Module wiring tests fill the gap between unit and E2E.

2. **Tech spec gates prevent rework.** The YAML schema contract between Epic 3 and Epic 4 was worth the upfront investment. Apply to Epic 4 where needed.

3. **Story sizing directly correlates with quality.** Small stories (3.9, 3.10) had clean reviews with 3-7 findings. Large stories (3.2, 3.6b) had 17+ findings and extended review cycles. Target: max ~60 tests per story.

4. **Process corrections stick when codified.** All 4 Epic 2 corrections became Rules 14-20 in project-context.md and were maintained throughout Epic 3. Rules that are written down and enforced by tooling (ESLint) are more reliable than verbal agreements.

5. **Hands-on UI testing is irreplaceable.** Lucide icon bug, comma bug, markdown sections bug — all invisible to automated tests, found in minutes by a human clicking through the UI.

6. **NestJS guard execution order is non-obvious.** Global guards (APP_GUARD) execute before controller-level guards. Document all guard ordering decisions explicitly.

7. **Party mode enables better architectural decisions.** The node-graph → atomic workflow pivot, BullMQ safety split, knowledge base deferral — all were discussed and decided in party mode format with clear rationale.

8. **Knowledge base features are Phase 2.** Backend code remains intact but is not used in MVP. Workflows use file uploads from Data Vault as inputs, not RAG search. This was a scope clarity decision, not a quality compromise.

9. **Three-layer testing pyramid is essential.** Unit tests (logic), module wiring tests (integration/compilation), E2E tests (user flows). All three layers are required for confidence.

10. **Prompt is the single source of truth for workflow output structure.** Admin defines structure in the prompt; wizard parses it automatically. No manual re-entry. (Story 3.11 — decided during retro.)

---

## Action Items

### Process Improvements (MANDATORY)

| # | Action | Owner | Success Criteria | When |
|---|--------|-------|------------------|------|
| 1 | **Enforce story size limits** — No story should produce >60 tests. Split if larger. | Bob (SM) | Zero oversized stories in Epic 4 | Epic 4 onward |
| 2 | **Browser smoke test for UI stories** — Don't rely solely on unit tests for frontend. App startup verification before code review. | erinc (PL) | Each UI story tested in browser before done | Epic 4 onward |
| 3 | **Document guard ordering decisions** — Any new guard registration must specify execution order explicitly | Charlie (Dev) | All guards have documented ordering rationale | Epic 4 onward |
| 4 | **Verify codebase before story creation** — Routes, interfaces, services, DTOs verified against actual code | Bob (SM) + Charlie (Dev) | Zero route/interface mismatches | Epic 4 onward |
| 5 | **TenantId automated enforcement** — Grep/CI check for raw SQL queries missing tenant_id. PLUS code review checklist item. | Charlie (Dev) | Zero omissions reaching code review | Before Epic 4 |
| 6 | **Party mode is DEFAULT** — Planning, post-implementation, and code review. Small stories can be exempted case-by-case if team raises it. | All | Every story gets party mode reviews | Immediate |
| 7 | **Module wiring / integration tests** — NestJS module compilation tests + Angular component integration tests. New standard test category. | Charlie (Dev) + Dana (QA) | All epics have wiring tests before Epic 4 | Before Epic 4 |

### Feature Stories (from retro discussions)

| # | Story | Description | When |
|---|-------|-------------|------|
| 1 | **Story 3.11** — Prompt-to-output auto-population | Option A: Convention-based parsing. Prompt is single source of truth. Admin follows documented template with `## Output Structure` section; wizard parses and populates. Fallback: single section with workflow template name if no structure detected. | Before Epic 4 |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| 1 | Defense-in-depth tenantId in raw SQL queries | MEDIUM | Automated check before Epic 4. Legacy queries deferred to Epic 7 |
| 2 | Email invitations (SMTP) | LOW | Expected — no SMTP in local dev. Epic 7P |
| 3 | Knowledge base features | DEFERRED | Phase 2 |
| 4 | Test Connection for LLM providers | DEFERRED | Epic 4 (needs SDK integration) |
| 5 | Audit Trail | DEFERRED | Epic 7 Story 7-2 |

### Epic 4 Planning Agenda (captured, discuss when Epic 4 starts)

| # | Topic | Notes |
|---|-------|-------|
| 1 | Circuit breaker for LLM providers | Stop sending after N consecutive failures, surface error to user |
| 2 | Per-tenant safety cap / budget system | Design before execution engine. Even simple "max N requests per run" safety cap |
| 3 | In-process BullMQ consumer first | Keep in api-gateway (like Epic 2 ingestion). Extract to worker-engine later when scaling needed |
| 4 | Credit/billing system design | How to track, debit, enforce limits per tenant |
| 5 | Output validation strategies | Verifying LLM output matches expected schema |
| 6 | Fan-out/fan-in patterns | Parallel job execution + result aggregation with BullMQ |
| 7 | Token budget management | Ensuring prompts don't exceed model context windows |

### Team Agreements (carried + new)

**Carried from Epic 2:**
- Every test run reports ALL metrics (tests per project, lint errors, warnings)
- Quality gates are PASS/FAIL — no MVP exceptions
- Code review presents findings before fixing
- All TypeORM WHERE clauses include tenantId on tenant-scoped entities

**New from Epic 3 retro:**
- Stories must be right-sized (max ~60 tests / ~3 spec files per story)
- All guard registrations must specify explicit execution order
- UI stories require browser smoke test before code review
- Story creation must verify actual codebase (routes, interfaces, services)
- Party mode is default for every story (planning, post-implementation, code review)
- Module wiring tests are a standard test category for all epics
- TenantId enforcement: automated grep/CI check + code review checklist
- Prompt is single source of truth for workflow output structure (no manual re-entry)

---

## Execution Plan (agreed during retro)

| # | Item | Type | Status |
|---|------|------|--------|
| 1 | Finalize Epic 3 retrospective | Retro | ✅ Done |
| 2 | Story 3.11 — prompt-to-output auto-population | Feature | Pending |
| 3 | Module wiring tests story (Epics 1, 2, 3) | Testing | Pending |
| 4 | Run wiring tests, fix issues | Verification | Pending |
| 5 | Story 3E update (+4 E2E tests) | Testing | Pending |
| 6 | Story 4E (~12 E2E tests) | Testing | Pending |
| 7 | Run full E2E suite, fix issues | Verification | Pending |
| 8 | Epic 4 — Story 4-0 first (BullMQ safety) | Development | Pending |

---

## Dependencies on Epic 3 — All Met (for Epic 4)

| Dependency | Status |
|-----------|--------|
| Workflow templates + versions + publishing | ✅ |
| YAML schema contract (tech spec) | ✅ |
| Chain definitions for orchestration | ✅ |
| LLM model config (entity + CRUD + UI) | ✅ |
| Provider credential storage (encrypted) | ✅ |
| Visibility/access control | ✅ |
| TenantStatusGuard for tenant routes | ✅ |
| E2E test framework | ✅ |

---

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | PASS | 944 tests, 0 lint errors, E2E framework operational |
| Technical Health | PASS | Stable foundation. Guard fix applied. RxJS leaks eliminated. |
| Process Health | PASS | All Epic 2 corrections maintained. 9 new action items defined. |
| Dependencies for Epic 4 | MET | All workflow definition infrastructure complete |
| Critical Path | Wiring tests + E2E + 3.11 | Foundation verification before Epic 4 |
| Significant Discoveries | None blocking | Epic 4 planning agenda captured for discussion |

---

## Comparison Across Epics

| Metric | Epic 1 | Epic 2 | Epic 3 |
|--------|--------|--------|--------|
| Deliverables | 10 stories | 4 stories | 21 deliverables |
| Tests | 219 | 406 (+187) | 944 (+538) |
| Code review findings | ~40 (~4/story) | ~30 (~7.5/story) | ~90+ (~4.3/story) |
| Lint errors | 0 | 0 | 0 |
| Process issues | Minor | 3 CRITICAL | 0 CRITICAL (improvements held) |
| New patterns | RLS, JWT, RBAC | pgvector, BullMQ, hexagonal | Atomic workflows, signals, E2E, encryption |
| Test layers | Unit only | Unit only | Unit + E2E (wiring tests planned) |

**Key trend:** Technical quality and process discipline have improved steadily across epics. Epic 3 was the largest and most complex epic but had the cleanest process execution.

---

## Closing Remarks

**Alice (PO):** *"Foundation built."*
**Charlie (Dev):** *"Trust but verify — in the browser."*
**Dana (QA):** *"944 and counting."*
**Elena (Dev):** *"Process discipline works."*
**Bob (SM):** *"Biggest epic, cleanest execution."*
**erinc (PL):** Acknowledged the team's work, emphasized the importance of verifying the foundation with wiring tests and E2E before building Epic 4. "Before starting Epic 4 we have to finish all and be confident of the foundation."

---

*Epic 3 delivered 21 story-level deliverables with 538 new tests (+133% growth), establishing the complete workflow definition layer. All 4 Epic 2 process corrections were maintained — the MVP excuse is permanently banned. New challenges emerged (story sizing, guard architecture, unit test limitations, tenantId omission) and each has a concrete action item with automated enforcement. The team added new practices: party mode as default, module wiring tests as a standard test layer, and prompt-to-output auto-population as a feature. The execution plan is clear: verify the foundation (wiring tests + E2E), deliver Story 3.11, then start Epic 4. The team enters Epic 4 with the strongest process discipline and test infrastructure to date.*
