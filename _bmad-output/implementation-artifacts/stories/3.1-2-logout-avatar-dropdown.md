# Story 3.1-2: Logout Button & Avatar Dropdown

Status: done

## Story

**As a** User (any role),
**I want** a user avatar dropdown menu replacing the standalone logout button,
**So that** I have a professional, consistent way to access my profile info, settings, and logout across all layouts.

## Background

The current logout button in the admin sidebar footer is a plain text button that looks unfinished. This needs to be replaced with a user avatar dropdown menu that:
- Shows user initials or avatar
- Provides dropdown with: profile info, settings link, logout
- Applies to ALL layout components (admin-layout and app-layout)
- Works for all user roles (bubble_admin, tenant users)

This was identified during Story 3.2 UI testing and captured as Epic 3 retro item #1/#7.

**Implementation note:** The original story did not account for a backend prerequisite — JWT tokens only contain `sub`, `tenant_id`, `role` (no email or name). A `GET /api/auth/me` endpoint was added to fetch the full user profile, and the frontend AuthService was enhanced with a `user` signal populated via `loadProfile()`.

## Acceptance Criteria

1. **Avatar Component** - User avatar shows initials (first+last) with colored background
2. **Dropdown Menu** - Click avatar opens dropdown with: display name, email, role badge, divider, Settings link, Logout action
3. **Admin Layout** - Avatar dropdown replaces logout button in admin-layout sidebar footer
4. **App Layout** - Avatar dropdown replaces user-info placeholder in app-layout sidebar footer
5. **Logout Action** - Clicking logout clears auth state and redirects to login
6. **Settings Link** - Links to /admin/settings (Story 3.1-1); closes dropdown on click
7. **Click Outside** - Dropdown closes when clicking outside
8. **Test IDs** - All interactive elements have data-testid attributes

## Tasks

### Task 1: Create Avatar Dropdown Component
- [x] Create `avatar-dropdown.component.ts` as standalone component
- [x] Display user initials with colored background (derive from name)
- [x] Dropdown panel: name, email, role badge, divider, Settings, Logout
- [x] Click outside to close (HostListener)
- [x] Add data-testid attributes

### Task 2: Integrate into Admin Layout
- [x] Replace logout button in `admin-layout.component.ts` sidebar footer
- [x] Wire up logout action to existing auth service
- [x] Wire up settings link to /admin/settings

### Task 3: Integrate into App Layout
- [x] Add AuthService + Router injection to `app-layout.component.ts`
- [x] Replace static user-info in sidebar footer with avatar dropdown
- [x] Same dropdown behavior as admin layout (showSettingsLink=false for non-admin)

### Task 4: Unit Tests
- [x] Avatar dropdown renders with user initials
- [x] Dropdown opens/closes on click
- [x] Logout action calls auth service
- [x] Settings link navigates correctly
- [x] Click outside closes dropdown
- [x] Test both admin-layout and app-layout integration

### Task 5: Documentation Subtask (Rule 17)
- [x] Tooltip on avatar hover showing full name (`title` attribute)
- [x] Accessible labels for screen readers (`aria-label`, `aria-expanded`, `aria-haspopup`, `role="menu"`, `role="menuitem"`)

### Task 6: Backend Prerequisite (GET /api/auth/me)
- [x] Add `getProfile()` method to backend `AuthService`
- [x] Add `GET /auth/me` endpoint with JwtAuthGuard + Swagger docs
- [x] Add `name?` and `status?` to shared `User` type
- [x] Add `user` signal and `loadProfile()` to frontend `AuthService`
- [x] Backend + frontend tests for profile endpoint

## Definition of Done

- [x] All acceptance criteria met
- [x] All tests pass (api-gateway: 359, web: 324)
- [x] Lint passes (api-gateway: 0 errors, web: 0 errors)
- [x] Build succeeds
- [x] Code review passed (2 rounds)
- [x] AC-to-test traceability table complete (Rule 12b)

## Test Traceability

| AC | Test ID | Test File | Description | Status |
|----|---------|-----------|-------------|--------|
| AC1 | 3.1-2-UNIT-010 | avatar-dropdown.component.spec.ts | Initials from name "Jane Doe" → "JD" | PASS |
| AC1 | 3.1-2-UNIT-011 | avatar-dropdown.component.spec.ts | Initials from email "jane@test.com" → "J" | PASS |
| AC2 | 3.1-2-UNIT-012 | avatar-dropdown.component.spec.ts | Click trigger opens dropdown | PASS |
| AC2 | 3.1-2-UNIT-018 | avatar-dropdown.component.spec.ts | Role badge "Bubble Admin" for bubble_admin | PASS |
| AC2 | 3.1-2-UNIT-019 | avatar-dropdown.component.spec.ts | Role badge "Creator" for creator | PASS |
| AC3 | 1H.1-UNIT-006 | admin-layout.component.spec.ts | Avatar dropdown present in admin layout | PASS |
| AC3 | 3.1-2-UNIT-020 | admin-layout.component.spec.ts | No avatar when user is null | PASS |
| AC4 | 3.1-2-UNIT-024 | app-layout.component.spec.ts | Avatar dropdown present in app layout | PASS |
| AC5 | 3.1-2-UNIT-015 | avatar-dropdown.component.spec.ts | Logout emits logoutClicked | PASS |
| AC5 | 1H.1-UNIT-007 | admin-layout.component.spec.ts | Logout calls authService.logout + router.navigate | PASS |
| AC5 | 3.1-2-UNIT-025 | app-layout.component.spec.ts | Logout calls authService.logout + router.navigate | PASS |
| AC5 | 3.1-2-UNIT-009 | auth.service.spec.ts | Logout clears user signal | PASS |
| AC6 | 3.1-2-UNIT-016 | avatar-dropdown.component.spec.ts | Settings link visible when showSettingsLink=true | PASS |
| AC6 | 3.1-2-UNIT-017 | avatar-dropdown.component.spec.ts | Settings link hidden when showSettingsLink=false | PASS |
| AC6 | 3.1-2-UNIT-028 | avatar-dropdown.component.spec.ts | Settings link click closes dropdown | PASS |
| AC7 | 3.1-2-UNIT-013 | avatar-dropdown.component.spec.ts | Click outside closes dropdown | PASS |
| AC7 | 3.1-2-UNIT-014 | avatar-dropdown.component.spec.ts | Escape key closes dropdown | PASS |
| AC7 | 3.1-2-UNIT-027 | avatar-dropdown.component.spec.ts | Focus returns to trigger on Escape | PASS |
| AC8 | 3.1-2-UNIT-026 | avatar-dropdown.component.spec.ts | aria-label and title on trigger | PASS |
| BE | 3.1-2-UNIT-001 | auth.service.spec.ts (BE) | getProfile returns UserResponseDto | PASS |
| BE | 3.1-2-UNIT-002 | auth.service.spec.ts (BE) | getProfile throws NotFoundException | PASS |
| BE | 3.1-2-UNIT-003 | auth.controller.spec.ts | GET /auth/me returns profile | PASS |
| BE | 3.1-2-UNIT-004 | auth.controller.spec.ts | GET /auth/me propagates NotFoundException | PASS |
| BE | 3.1-2-UNIT-005 | auth.service.spec.ts (FE) | loadProfile populates user signal | PASS |
| BE | 3.1-2-UNIT-006 | auth.service.spec.ts (FE) | loadProfile skips when no token | PASS |
| BE | 3.1-2-UNIT-007 | auth.service.spec.ts (FE) | loadProfile handles 401 gracefully | PASS |
| BE | 3.1-2-UNIT-008 | auth.service.spec.ts (FE) | Login triggers loadProfile | PASS |

## Dev Agent Record

### File List

| Action | File | Description |
|--------|------|-------------|
| MODIFY | libs/shared/src/lib/types/user.types.ts | Added `name?` and `status?` to User interface |
| MODIFY | apps/api-gateway/src/app/auth/auth.service.ts | Added `getProfile()` method |
| MODIFY | apps/api-gateway/src/app/auth/auth.controller.ts | Added `GET /auth/me` endpoint |
| MODIFY | apps/api-gateway/src/app/auth/auth.service.spec.ts | Added getProfile tests |
| MODIFY | apps/api-gateway/src/app/auth/auth.controller.spec.ts | Added GET /auth/me tests |
| MODIFY | apps/web/src/app/core/services/auth.service.ts | Added `user` signal, `loadProfile()`, constructor |
| MODIFY | apps/web/src/app/core/services/auth.service.spec.ts | Added loadProfile tests |
| CREATE | apps/web/src/app/shared/components/avatar-dropdown/avatar-dropdown.component.ts | Standalone component |
| CREATE | apps/web/src/app/shared/components/avatar-dropdown/avatar-dropdown.component.html | Template |
| CREATE | apps/web/src/app/shared/components/avatar-dropdown/avatar-dropdown.component.scss | Styles |
| CREATE | apps/web/src/app/shared/components/avatar-dropdown/avatar-dropdown.component.spec.ts | 13 unit tests |
| MODIFY | apps/web/src/app/admin/admin-layout.component.ts | Added AvatarDropdownComponent, user computed |
| MODIFY | apps/web/src/app/admin/admin-layout.component.html | Replaced sidebar footer |
| MODIFY | apps/web/src/app/admin/admin-layout.component.spec.ts | Updated mock, tests for avatar dropdown |
| MODIFY | apps/web/src/app/app-shell/app-layout.component.ts | Added AuthService, Router, logout, user computed |
| MODIFY | apps/web/src/app/app-shell/app-layout.component.html | Replaced sidebar footer |
| CREATE | apps/web/src/app/app-shell/app-layout.component.spec.ts | 4 unit tests |

## Change Log

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-04 | Retrospective | Extracted from Story 7-7 (UI Polish Pass) task 4, Epic 3 retro items #1, #7 |
| 2026-02-04 | Restructure | Created as 3.1-2 in Epic 3.1: Settings & Essentials |
| 2026-02-05 | Dev Agent | Implemented all tasks: backend GET /auth/me, frontend AuthService user signal, AvatarDropdownComponent, admin+app layout integration |
| 2026-02-05 | Code Review | Round 1: Found 8 issues (2 critical, 2 high, 2 medium, 2 low). Fixed: aria-label, title tooltip, @ApiResponse(404), settings link close, focus management, HostListener guard. Added 3 new tests (UNIT-026/027/028). |
| 2026-02-05 | Code Review | Round 2: PASS. All issues resolved. Story marked done. |
