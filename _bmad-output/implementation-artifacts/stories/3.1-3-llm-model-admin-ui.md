# Story 3.1-3: LLM Model Admin UI

Status: done

## Story

**As a** Bubble Admin,
**I want** a UI to manage LLM models (view, add, edit, enable/disable) within the Settings page,
**So that** I can configure which AI models are available for workflow execution without using SQL or API calls.

## Background

The backend for LLM model CRUD already exists and is fully functional. This story adds the frontend admin UI inside the Settings page's "LLM Models" tab.

### Codebase Context (Verified)

**Backend entity** — `libs/db-layer/src/lib/entities/llm-model.entity.ts`: `LlmModelEntity` with fields: `id`, `providerKey` (e.g. "google-ai-studio"), `modelId` (e.g. "models/gemini-2.0-flash"), `displayName`, `contextWindow`, `maxOutputTokens`, `isActive`, `costPer1kInput`, `costPer1kOutput`, `createdAt`, `updatedAt`. System-wide table (no tenant_id, exempt from RLS).

**Backend controller** — `apps/api-gateway/src/app/workflows/llm-models.controller.ts`:
- `GET /api/admin/llm-models` — Returns all models (including inactive). Roles: `BUBBLE_ADMIN`.
- `POST /api/admin/llm-models` — Create model. Validates unique(providerKey, modelId).
- `PATCH /api/admin/llm-models/:id` — Update model fields.
- No DELETE endpoint exists (deactivation via `isActive: false` is the pattern).

**Backend service** — `apps/api-gateway/src/app/workflows/llm-models.service.ts`: Methods: `findAll()`, `findAllActive()`, `create(dto)`, `update(id, dto)`.

**DTOs** — `libs/shared/src/lib/dtos/workflow/`:
- `CreateLlmModelDto`: providerKey (string, max 50), modelId (string, max 100), displayName (string, max 100), contextWindow (int), maxOutputTokens (int), isActive? (boolean), costPer1kInput? (decimal string), costPer1kOutput? (decimal string)
- `UpdateLlmModelDto`: All fields optional (PartialType of Create)
- `LlmModelResponseDto`: All entity fields

**Frontend service** — `apps/web/src/app/core/services/llm-model.service.ts`: Only has `getActiveModels()` calling `GET /api/app/llm-models`. Missing admin methods.

**Settings page** — Created in Story 3.1-1 with "LLM Models" tab placeholder.

## Acceptance Criteria

1. **Model list** — LLM Models tab shows a table/list of all models (active and inactive) with provider, name, model ID, context window, status
2. **Add model** — "Add Model" button opens form with all CreateLlmModelDto fields; providerKey is a dropdown of known providers (google-ai-studio, vertex, mock)
3. **Edit model** — Click row/edit button opens pre-filled form for updating display name, context window, max output tokens, cost fields, active status
4. **Toggle active** — Quick toggle to enable/disable a model without opening edit form
5. **Provider grouping** — Models grouped visually by providerKey (e.g. section headers)
6. **Validation** — Form validation matches DTO constraints (required fields, max lengths, min values)
7. **Error handling** — 409 duplicate shows user-friendly message; other errors show generic retry message
8. **Loading states** — Spinner during list load and form submission

## Tasks

### Task 1: Extend Frontend LlmModelService
- [x] Add admin methods to `apps/web/src/app/core/services/llm-model.service.ts`:
  - `getAllModels(): Observable<LlmModel[]>` → `GET /api/admin/llm-models`
  - `createModel(dto: CreateLlmModelDto): Observable<LlmModel>` → `POST /api/admin/llm-models`
  - `updateModel(id: string, dto: UpdateLlmModelDto): Observable<LlmModel>` → `PATCH /api/admin/llm-models/:id`
- **Note:** Use `UpdateLlmModelDto` (not `Partial<CreateLlmModelDto>`) — the update DTO intentionally excludes `providerKey` and `modelId` since they form the unique key and cannot be changed after creation.

### Task 2: Create LLM Models List Component
- [x] Create `apps/web/src/app/admin/settings/llm-models-list.component.ts` (standalone)
- [x] Table with columns: Provider, Display Name, Model ID, Context Window, Max Output, Status (active/inactive toggle), Actions (edit)
- [x] Group rows by providerKey with section headers
- [x] "Add Model" button in top-right
- [x] Loading skeleton state
- [x] Empty state: "No models configured. Add your first LLM model."
- [x] Add `data-testid` attributes

### Task 3: Create LLM Model Form Dialog
- [x] Create `apps/web/src/app/admin/settings/llm-model-form-dialog.component.ts` (standalone)
- [x] Reactive form with fields matching CreateLlmModelDto
- [x] providerKey: dropdown with options ["google-ai-studio", "vertex", "mock"]
- [x] modelId: text input (e.g. "models/gemini-2.0-flash")
- [x] displayName: text input
- [x] contextWindow: number input (min 1)
- [x] maxOutputTokens: number input (min 1)
- [x] costPer1kInput/Output: optional decimal inputs
- [x] isActive: checkbox (default true)
- [x] Mode: "Add" vs "Edit" (pre-populate fields in edit mode)
- [x] **Edit mode constraint:** providerKey and modelId fields must be read-only (disabled inputs) since they form the unique key and cannot be changed after creation per `UpdateLlmModelDto`
- [x] Submit button with loading state
- [x] Error handling: 409 → "A model with this provider + model ID already exists"

### Task 4: Integrate into Settings Page
- [x] Replace placeholder content in Settings "LLM Models" tab with `<app-llm-models-list>`
- [x] Wire up dialog open/close signals

### Task 5: Unit Tests
**Test ID format:** `[3.1-3-UNIT-XXX]` for traceability

- [x] LlmModelService: test getAllModels, createModel, updateModel HTTP calls
- [x] LlmModelsListComponent: renders model list, handles loading, handles empty state, provider grouping
- [x] LlmModelFormDialog: form validation, submit, error handling, edit mode read-only fields
- [x] Integration: dialog opens from list, list refreshes after add/edit

## Files Created/Modified

| File | Action | Details |
|------|--------|---------|
| `apps/web/src/app/core/services/llm-model.service.ts` | MODIFIED | Added getAllModels, createModel, updateModel methods |
| `apps/web/src/app/core/services/llm-model.service.spec.ts` | CREATED | 4 tests for admin service methods |
| `apps/web/src/app/admin/settings/llm-models-list.component.ts` | CREATED | Model list with provider grouping and toggle |
| `apps/web/src/app/admin/settings/llm-models-list.component.html` | CREATED | List template with data-testid attributes |
| `apps/web/src/app/admin/settings/llm-models-list.component.scss` | CREATED | List styles |
| `apps/web/src/app/admin/settings/llm-models-list.component.spec.ts` | CREATED | 11 tests for list component |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.ts` | CREATED | Add/edit form dialog with validation |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.html` | CREATED | Form template with a11y |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.scss` | CREATED | Form and dialog styles |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.spec.ts` | CREATED | 11 tests for form dialog |
| `apps/web/src/app/admin/settings/settings.component.ts` | MODIFIED | Added dialog state and methods |
| `apps/web/src/app/admin/settings/settings.component.html` | MODIFIED | Integrated llm-models-list and form dialog |
| `apps/web/src/app/admin/settings/settings.component.spec.ts` | MODIFIED | Updated tests, added 3 integration tests |

## Dependencies

- **Requires Story 3.1-1** (Settings page shell must exist) ✅

## Definition of Done

- [x] All acceptance criteria met
- [x] All tests pass (353 tests)
- [x] Lint passes
- [x] Code review passed

## Traceability

| Test ID | Description | File |
|---------|-------------|------|
| [3.1-3-UNIT-001] | getActiveModels GET /api/app/llm-models | llm-model.service.spec.ts |
| [3.1-3-UNIT-002] | getAllModels GET /api/admin/llm-models | llm-model.service.spec.ts |
| [3.1-3-UNIT-003] | createModel POST /api/admin/llm-models | llm-model.service.spec.ts |
| [3.1-3-UNIT-004] | updateModel PATCH /api/admin/llm-models/:id | llm-model.service.spec.ts |
| [3.1-3-UNIT-005] | LlmModelsListComponent should create | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-006] | should render model list on load | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-007] | should show loading skeleton while loading | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-008] | should show empty state when no models | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-009] | should show error banner on API failure | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-010] | should group models by provider | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-011] | should emit addModelClicked | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-012] | should emit editModelClicked | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-013] | should toggle model active status | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-014] | should format context window correctly | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-015] | should display provider display names | llm-models-list.component.spec.ts |
| [3.1-3-UNIT-016] | should create in add mode | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-017] | should create in edit mode with pre-filled values | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-018] | should disable providerKey and modelId in edit mode | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-019] | should validate required fields | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-020] | should call createModel on valid add form submit | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-021] | should call updateModel on valid edit form submit | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-022] | should show error for 409 conflict | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-023] | should emit cancelled when cancel button clicked | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-024] | should emit cancelled when backdrop clicked | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-025] | should show provider dropdown options in add mode | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-026] | should show read-only hint in edit mode | llm-model-form-dialog.component.spec.ts |
| [3.1-3-UNIT-027] | should open add dialog when openAddDialog called | settings.component.spec.ts |
| [3.1-3-UNIT-028] | should open edit dialog with model | settings.component.spec.ts |
| [3.1-3-UNIT-029] | should close dialog and refresh list on model saved | settings.component.spec.ts |

## Change Log

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-05 | Quality Review | Created from 3.1-1 breakdown. Builds frontend for existing backend LLM model CRUD. |
| 2026-02-06 | Pre-Dev Review | Fixed 3 issues: (1) Task 1: Changed `Partial<CreateLlmModelDto>` to `UpdateLlmModelDto`; (2) Task 3: Added edit mode constraint for read-only providerKey/modelId; (3) Task 5: Added test ID format `[3.1-3-UNIT-XXX]` |
| 2026-02-06 | Implementation | Completed all tasks. 29 unit tests added. All acceptance criteria met. |
