# Story 3.1-3: LLM Model Admin UI

Status: ready-for-dev

## Story

**As a** Bubble Admin,
**I want** a UI to manage LLM models (view, add, edit, enable/disable) within the Settings page,
**So that** I can configure which AI models are available for workflow execution without using SQL or API calls.

## Background

The backend for LLM model CRUD already exists and is fully functional. This story adds the frontend admin UI inside the Settings page's "LLM Models" tab.

### Codebase Context (Verified)

**Backend entity** — `libs/db-layer/src/lib/entities/llm-model.entity.ts`: `LlmModelEntity` with fields: `id`, `providerKey` (e.g. "google-ai-studio"), `modelId` (e.g. "models/gemini-2.0-flash"), `displayName`, `contextWindow`, `maxOutputTokens`, `isActive`, `costPer1kInput`, `costPer1kOutput`, `createdAt`, `updatedAt`. System-wide table (no tenant_id, exempt from RLS).

**Backend controller** — `apps/api-gateway/src/app/workflows/llm-models.controller.ts`:
- `GET /api/admin/llm-models` — Returns all models (including inactive). Roles: `BUBBLE_ADMIN`.
- `POST /api/admin/llm-models` — Create model. Validates unique(providerKey, modelId).
- `PATCH /api/admin/llm-models/:id` — Update model fields.
- No DELETE endpoint exists (deactivation via `isActive: false` is the pattern).

**Backend service** — `apps/api-gateway/src/app/workflows/llm-models.service.ts`: Methods: `findAll()`, `findAllActive()`, `create(dto)`, `update(id, dto)`.

**DTOs** — `libs/shared/src/lib/dtos/workflow/`:
- `CreateLlmModelDto`: providerKey (string, max 50), modelId (string, max 100), displayName (string, max 100), contextWindow (int), maxOutputTokens (int), isActive? (boolean), costPer1kInput? (decimal string), costPer1kOutput? (decimal string)
- `UpdateLlmModelDto`: All fields optional (PartialType of Create)
- `LlmModelResponseDto`: All entity fields

**Frontend service** — `apps/web/src/app/core/services/llm-model.service.ts`: Only has `getActiveModels()` calling `GET /api/app/llm-models`. Missing admin methods.

**Settings page** — Created in Story 3.1-1 with "LLM Models" tab placeholder.

## Acceptance Criteria

1. **Model list** — LLM Models tab shows a table/list of all models (active and inactive) with provider, name, model ID, context window, status
2. **Add model** — "Add Model" button opens form with all CreateLlmModelDto fields; providerKey is a dropdown of known providers (google-ai-studio, vertex, mock)
3. **Edit model** — Click row/edit button opens pre-filled form for updating display name, context window, max output tokens, cost fields, active status
4. **Toggle active** — Quick toggle to enable/disable a model without opening edit form
5. **Provider grouping** — Models grouped visually by providerKey (e.g. section headers)
6. **Validation** — Form validation matches DTO constraints (required fields, max lengths, min values)
7. **Error handling** — 409 duplicate shows user-friendly message; other errors show generic retry message
8. **Loading states** — Spinner during list load and form submission

## Tasks

### Task 1: Extend Frontend LlmModelService
- [ ] Add admin methods to `apps/web/src/app/core/services/llm-model.service.ts`:
  - `getAllModels(): Observable<LlmModel[]>` → `GET /api/admin/llm-models`
  - `createModel(dto: CreateLlmModelDto): Observable<LlmModel>` → `POST /api/admin/llm-models`
  - `updateModel(id: string, dto: Partial<CreateLlmModelDto>): Observable<LlmModel>` → `PATCH /api/admin/llm-models/:id`

### Task 2: Create LLM Models List Component
- [ ] Create `apps/web/src/app/admin/settings/llm-models-list.component.ts` (standalone)
- [ ] Table with columns: Provider, Display Name, Model ID, Context Window, Max Output, Status (active/inactive toggle), Actions (edit)
- [ ] Group rows by providerKey with section headers
- [ ] "Add Model" button in top-right
- [ ] Loading skeleton state
- [ ] Empty state: "No models configured. Add your first LLM model."
- [ ] Add `data-testid` attributes

### Task 3: Create LLM Model Form Dialog
- [ ] Create `apps/web/src/app/admin/settings/llm-model-form-dialog.component.ts` (standalone)
- [ ] Reactive form with fields matching CreateLlmModelDto
- [ ] providerKey: dropdown with options ["google-ai-studio", "vertex", "mock"]
- [ ] modelId: text input (e.g. "models/gemini-2.0-flash")
- [ ] displayName: text input
- [ ] contextWindow: number input (min 1)
- [ ] maxOutputTokens: number input (min 1)
- [ ] costPer1kInput/Output: optional decimal inputs
- [ ] isActive: checkbox (default true)
- [ ] Mode: "Add" vs "Edit" (pre-populate fields in edit mode)
- [ ] Submit button with loading state
- [ ] Error handling: 409 → "A model with this provider + model ID already exists"

### Task 4: Integrate into Settings Page
- [ ] Replace placeholder content in Settings "LLM Models" tab with `<app-llm-models-list>`
- [ ] Wire up dialog open/close signals

### Task 5: Unit Tests
- [ ] LlmModelService: test getAllModels, createModel, updateModel HTTP calls
- [ ] LlmModelsListComponent: renders model list, handles loading, handles empty state
- [ ] LlmModelFormDialog: form validation, submit, error handling
- [ ] Integration: dialog opens from list, list refreshes after add/edit

## Files to Create/Modify

| File | Action | Details |
|------|--------|---------|
| `apps/web/src/app/core/services/llm-model.service.ts` | MODIFY | Add admin CRUD methods (3 methods) |
| `apps/web/src/app/admin/settings/llm-models-list.component.ts` | CREATE | Model list with grouping and toggle |
| `apps/web/src/app/admin/settings/llm-models-list.component.html` | CREATE | List template |
| `apps/web/src/app/admin/settings/llm-models-list.component.scss` | CREATE | List styles |
| `apps/web/src/app/admin/settings/llm-models-list.component.spec.ts` | CREATE | List tests |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.ts` | CREATE | Add/edit form dialog |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.html` | CREATE | Form template |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.scss` | CREATE | Form styles |
| `apps/web/src/app/admin/settings/llm-model-form-dialog.component.spec.ts` | CREATE | Form tests |
| `apps/web/src/app/admin/settings/settings.component.ts` | MODIFY | Replace placeholder with llm-models-list |
| `apps/web/src/app/admin/settings/settings.component.html` | MODIFY | Wire up LLM models tab content |
| `apps/web/src/app/core/services/llm-model.service.spec.ts` | CREATE or MODIFY | Test admin methods |

## Dependencies

- **Requires Story 3.1-1** (Settings page shell must exist)

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests pass
- [ ] Lint passes
- [ ] Code review passed

## Change Log

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-05 | Quality Review | Created from 3.1-1 breakdown. Builds frontend for existing backend LLM model CRUD. |
