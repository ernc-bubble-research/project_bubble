# Story 3.1-4: LLM Provider Credential Storage

Status: ready-for-dev

## Story

**As a** Bubble Admin,
**I want** to securely store and manage API keys and provider-specific configuration for each LLM provider,
**So that** the execution engine (Epic 4) can authenticate with LLM providers without relying on environment variables.

## Background

Currently, LLM provider credentials are stored as environment variables (`GEMINI_API_KEY` in `.env`). This works for single-provider setups but doesn't scale to multiple providers or runtime configuration. This story adds a database-backed credential storage system with encryption.

### Codebase Context (Verified)

**Existing env vars** — `.env.example:37-44`: Only `GEMINI_API_KEY` and `EMBEDDING_PROVIDER`/`EMBEDDING_MODEL` exist. No `LLM_PROVIDER`, `GOOGLE_AI_STUDIO_API_KEY`, or `VERTEX_PROJECT_ID` (these were invented by the original failed story).

**Existing LLM model entity** — `libs/db-layer/src/lib/entities/llm-model.entity.ts`: Models reference `providerKey` (e.g. "google-ai-studio") but there is no corresponding provider config entity that stores credentials for that provider.

**ConfigModule** — `apps/api-gateway/src/app/app.module.ts`: Uses NestJS `ConfigModule.forRoot({ isGlobal: true })` with `.env` file. The existing `GEMINI_API_KEY` env var should become the fallback when no DB config exists.

**Entity registration** — `libs/db-layer/src/lib/entities/index.ts`: Exports 11 entities. New entity must be added here.

**Encryption** — No encryption utilities exist in the codebase currently. Need to implement using Node.js `crypto` module (AES-256-GCM).

**Provider types** — LlmModelEntity.providerKey values: "google-ai-studio", "vertex", "mock". Each provider type needs different credential fields.

### Provider Credential Schema

| Provider Key | Required Fields | Optional Fields |
|-------------|----------------|-----------------|
| `google-ai-studio` | `apiKey` | — |
| `vertex` | `projectId`, `location` | `serviceAccountJson` |
| `mock` | — | — |

## Acceptance Criteria

1. **Provider config entity** — `LlmProviderConfigEntity` stores provider type, display name, encrypted credentials (JSON), and active status
2. **Encrypted storage** — API keys and credentials are encrypted at rest using AES-256-GCM with an application-level encryption key from env var
3. **Masked responses** — GET endpoints never return full credentials; API keys show only last 4 characters (e.g. "****abcd")
4. **CRUD API** — Admin endpoints for list, create, update provider configs
5. **Provider-specific validation** — Creating a google-ai-studio provider requires apiKey; vertex requires projectId + location
6. **UI section** — Provider configuration section in Settings page (separate from LLM Models tab, or as a sub-section within it)
7. **Env var fallback** — If no DB provider config exists for a provider key, fall back to env var (GEMINI_API_KEY → google-ai-studio)
8. **Encryption key env var** — New `SETTINGS_ENCRYPTION_KEY` env var required, with clear error on startup if missing

## Tasks

### Task 1: Create Encryption Utility
- [ ] Create `apps/api-gateway/src/app/common/crypto.util.ts`
- [ ] `encrypt(plaintext: string, key: string): string` — AES-256-GCM, returns `iv:authTag:ciphertext` as base64
- [ ] `decrypt(encrypted: string, key: string): string` — Reverses encryption
- [ ] `maskSecret(value: string, visibleChars = 4): string` — Returns `****abcd`
- [ ] Unit tests for encrypt/decrypt round-trip, mask function

### Task 2: Create Provider Config Entity & DTOs
- [ ] Create `libs/db-layer/src/lib/entities/llm-provider-config.entity.ts`:
  - `id` (uuid), `providerKey` (unique, max 50), `displayName` (max 100), `encryptedCredentials` (text — encrypted JSON), `isActive` (boolean, default true), `createdAt`, `updatedAt`
  - System-wide table (no tenant_id, exempt from RLS like llm_models)
- [ ] Export from `libs/db-layer/src/lib/entities/index.ts`
- [ ] Create DTOs in `libs/shared/src/lib/dtos/settings/`:
  - `CreateLlmProviderConfigDto`: providerKey, displayName, credentials (JSON object with provider-specific fields)
  - `UpdateLlmProviderConfigDto`: Optional displayName, credentials, isActive
  - `LlmProviderConfigResponseDto`: id, providerKey, displayName, maskedCredentials (credentials with values masked), isActive, createdAt, updatedAt
- [ ] Export DTOs from shared index

### Task 3: Create Provider Config Service
- [ ] Create `apps/api-gateway/src/app/settings/llm-provider-config.service.ts`
- [ ] `findAll()` — Returns all configs with masked credentials
- [ ] `create(dto)` — Validates provider-specific required fields, encrypts credentials, saves
- [ ] `update(id, dto)` — Updates fields, re-encrypts if credentials provided
- [ ] `getDecryptedCredentials(providerKey)` — Internal method for execution engine (Epic 4), returns decrypted credentials; falls back to env vars if no DB config
- [ ] Inject ConfigService for `SETTINGS_ENCRYPTION_KEY`

### Task 4: Create Provider Config Controller
- [ ] Create `apps/api-gateway/src/app/settings/settings.module.ts` with TypeORM.forFeature([LlmProviderConfigEntity])
- [ ] Create `apps/api-gateway/src/app/settings/llm-provider-config.controller.ts`:
  - `GET /api/admin/settings/llm-providers` — List all (masked)
  - `POST /api/admin/settings/llm-providers` — Create
  - `PATCH /api/admin/settings/llm-providers/:id` — Update
- [ ] Roles: BUBBLE_ADMIN only
- [ ] Swagger decorators with @ApiResponse for all status codes
- [ ] Register SettingsModule in AppModule imports

### Task 5: Frontend Provider Config UI
- [ ] Create `apps/web/src/app/admin/settings/provider-config-list.component.ts`
- [ ] Provider cards: show provider name, type, status badge, masked API key
- [ ] Add/edit provider dialog with provider-type-specific form fields
- [ ] Create frontend service: `apps/web/src/app/core/services/settings.service.ts`
- [ ] Integrate into Settings page (as section within LLM Models tab or as separate "Providers" tab)

### Task 6: Unit Tests
- [ ] Crypto utility: encrypt/decrypt round-trip, mask function
- [ ] LlmProviderConfigService: CRUD operations, encryption verification, env var fallback
- [ ] LlmProviderConfigController: endpoint tests with auth/role guards
- [ ] Frontend components: list rendering, form validation, masked display

### Task 7: Environment Setup
- [ ] Add `SETTINGS_ENCRYPTION_KEY` to `.env.example` with generation instructions
- [ ] Add startup validation: throw clear error if SETTINGS_ENCRYPTION_KEY is missing or too short

## Files to Create/Modify

| File | Action | Details |
|------|--------|---------|
| `apps/api-gateway/src/app/common/crypto.util.ts` | CREATE | AES-256-GCM encrypt/decrypt/mask |
| `apps/api-gateway/src/app/common/crypto.util.spec.ts` | CREATE | Encryption tests |
| `libs/db-layer/src/lib/entities/llm-provider-config.entity.ts` | CREATE | Provider config entity |
| `libs/db-layer/src/lib/entities/index.ts` | MODIFY | Export new entity |
| `libs/shared/src/lib/dtos/settings/` | CREATE | DTOs directory + 3 DTO files |
| `libs/shared/src/lib/dtos/index.ts` | MODIFY | Export new DTOs |
| `apps/api-gateway/src/app/settings/settings.module.ts` | CREATE | NestJS module |
| `apps/api-gateway/src/app/settings/llm-provider-config.service.ts` | CREATE | Service with encryption |
| `apps/api-gateway/src/app/settings/llm-provider-config.service.spec.ts` | CREATE | Service tests |
| `apps/api-gateway/src/app/settings/llm-provider-config.controller.ts` | CREATE | Admin controller |
| `apps/api-gateway/src/app/settings/llm-provider-config.controller.spec.ts` | CREATE | Controller tests |
| `apps/api-gateway/src/app/app.module.ts` | MODIFY | Import SettingsModule |
| `apps/web/src/app/core/services/settings.service.ts` | CREATE | Frontend service |
| `apps/web/src/app/admin/settings/provider-config-list.component.ts` | CREATE | Provider list UI |
| `apps/web/src/app/admin/settings/provider-config-form-dialog.component.ts` | CREATE | Add/edit dialog |
| `.env.example` | MODIFY | Add SETTINGS_ENCRYPTION_KEY |

## Dependencies

- **Requires Story 3.1-1** (Settings page must exist)
- **Consumed by Epic 4** (execution engine uses `getDecryptedCredentials()` to authenticate with LLM providers)

## Deferred Items (Tracked)

These items from the original 3.1-1 story are explicitly deferred:

| Item | Deferred To | Rationale |
|------|-------------|-----------|
| **Test Connection** (original AC 7) | Epic 4 | Requires actual LLM provider SDK integration which is built in Epic 4. Add a "Test Connection" button to provider config UI after Epic 4 delivers the provider interface. |
| **Audit Trail** (original AC 8) | Epic 7 (Story 7-2: Audit Logging) | Cross-cutting concern that should apply to ALL admin actions, not just settings. Story 7-2 already covers audit logging. |
| **E2E Tests** (original Task 6) | E2E stories (1E/2E/3E) | E2E test framework doesn't exist yet. Covered by dedicated E2E stories. |

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Credentials encrypted at rest (verified by test)
- [ ] GET responses never contain plaintext credentials
- [ ] All tests pass
- [ ] Lint passes
- [ ] Code review passed

## Change Log

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-05 | Quality Review | Created from 3.1-1 breakdown. New backend entity + encryption + frontend UI for provider credentials. |
