# generated: 2026-01-30
# project: project_bubble
# project_key: bubble
# tracking_system: file-system
# story_location: stories

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic not yet started
#   - in-progress: Epic actively being worked on
#   - done: All stories in epic completed
#
# Epic Status Transitions:
#   - backlog → in-progress: Automatically when first story is created (via create-story)
#   - in-progress → done: Manually when all stories reach 'done' status
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - ready-for-dev: Story file created in stories folder
#   - in-progress: Developer actively working on implementation
#   - review: Ready for code review (via Dev's code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - done: Retrospective has been completed
#
# WORKFLOW NOTES:
# ===============
# - Epic transitions to 'in-progress' automatically when first story is created
# - Stories can be worked in parallel if team capacity allows
# - SM typically creates next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', then runs code-review (fresh context, different LLM recommended)
#
# PHASE SCOPE:
# ============
# Prototype (Phase 1): Epics 1-7 + 7P (production readiness)
# Phase 2 / Future:    Epics 8, 9, 10, 11 (4 epics, 10 stories)
#
# DEPENDENCY CHAIN (updated 2026-02-05 after Architect Review):
# Epic 1 → Epic 1H → Epic 2 + Epic 3 (parallel) → Epic 3.1 → Epic 4 → Epic 5 → Epic 6
# Epic 7 runs parallel to Epics 4-6
# Epic 7P (Production Readiness) runs parallel to Epics 4-6, must complete before production
#
# RECOMMENDED EXECUTION ORDER (updated 2026-02-05 after Architect Review):
# 1. Story 3H  — RxJS Subscription Cleanup (CRITICAL - memory leaks) ✓ DONE
# 2. Epic 3.1  — Settings + Essentials (4 stories):
#    a. 3.1-1 Settings Page Shell ✓ DONE
#    b. 3.1-2 Avatar Dropdown (logout UX improvement)
#    c. 3.1-3 LLM Model Admin UI (frontend for existing backend)
#    d. 3.1-4 Provider Credential Storage (new entity + encryption)
# 3. 1E/2E/3E — E2E Test Coverage (establish test framework) — 1E ✓ DONE
# 4. Story 3.9 — Wizard Documentation (needed to understand/test product)
# 5. Story 3.8 — Workflow Management View (visibility editing)
# 6. Story 1-13 — Tenant Lifecycle (archive/suspend/delete)
# 7. Epic 7P   — Production Readiness (can start parallel with Epic 4):
#    a. 7P-1 Deployment target decision + Dockerfiles
#    b. 7P-2 Cloud file storage migration (GCS/S3)
#    c. 7P-3 Secrets management integration
#    d. 7P-4 Database backup + disaster recovery
#    e. 7P-5 BullMQ hardening (circuit breaker, alerting — safety-critical DLQ/idempotency moved to 4.0)
#    f. 7P-6 RLS auth bypass security review + hardening
#    g. 7P-7 Load testing + capacity planning
#
# GATE REQUIREMENTS:
# ==================
# BEFORE Epic 3: Run /bmad:bmm:workflows:quick-spec for Workflow Definition Schema.
#   (UPDATED 2026-02-01: LangGraph.js DEFERRED — replaced by LLM-orchestrated execution)
#   Scope: YAML workflow schema for atomic workflows, input role taxonomy (context vs subject),
#   execution patterns (fan-out parallel, fan-in batch), workflow chain composition,
#   output spec and structural validation, context window token budget check.
#   Rationale: Epic 3 builds the UI that PRODUCES YAML workflow definitions; Epic 4 builds
#   the engine that CONSUMES them. The YAML schema contract must be defined first so the
#   form builder produces exactly what the execution engine needs. No rework.
#   This tech spec MUST be completed before any Epic 3 story is created.
#
# BEFORE Epic 4 Story 4.1 or 4.2: Build Mock LLM Provider alongside real providers.
#   The architecture specifies a Hexagonal LLM pattern (abstract provider interface).
#   - MockLlmProvider: Returns deterministic canned responses. Free, instant, for dev + unit tests.
#   - VertexLlmProvider: Real Google Vertex AI calls (paid). For production.
#   - GoogleAIStudioProvider: Free tier Google AI Studio API. For smoke tests + dev validation.
#   - Switched via LLM_PROVIDER env var (mock | google-ai-studio | vertex).
#   - Create a "smoke test" workflow (2 steps, 1-2 small docs) for real LLM validation.
#   - Mock provider covers engine logic (graph execution, state, retries, feedback loop).
#   - Google AI Studio (free tier) for real LLM integration testing without cost.
#   - Vertex AI for production workloads.
#   LLM TESTING STRATEGY:
#   - 90% development: MockLlmProvider (free, deterministic, fast)
#   - 10% validation: GoogleAIStudioProvider (free tier, real LLM responses)
#   - Production: VertexLlmProvider (paid, scalable)
#
# BEFORE Production Deployment (CRITICAL — from Architect Review 2026-02-05):
#   All items in Epic 7P must be completed. Key decisions required:
#   1. Deployment target: GCP (Cloud Run + Cloud SQL) vs AWS vs Render/Railway
#      - GCP implied by Vertex AI/Gemini dependency. Cascades to all infra choices.
#   2. File storage: Must migrate from local filesystem to cloud object storage.
#      - Current: uploads/<tenantId>/<uuid>-<filename> on local disk (not production-safe)
#      - AssetEntity.storage_path is a relative path — migration is swap-backend, keep-format
#   3. Secrets management: Must replace .env files with cloud secrets manager.
#      - Sensitive: JWT_SECRET, ADMIN_API_KEY, DATABASE_URL, GEMINI_API_KEY, SMTP_PASS
#      - No rotation, no encryption at rest, no audit trail currently
#   4. Database backups: No automated backup exists.
#      - docker compose down -v destroys all data
#      - Need pg_dump automation or managed DB with PITR
#   5. BullMQ hardening: No DLQ, no circuit breaker, no alerting on job failures.
#      - Safety-critical subset (DLQ + idempotency) moved to Epic 4 Story 4.0
#      - Remaining (circuit breaker, alerting) stays in 7P-5 for pre-production
#   6. RLS auth bypass policies: Permissive SELECT true on users/invitations tables.
#      - By design for pre-auth flows, but needs security review
#      - Consider dedicated DB roles to restrict access scope
#   7. Load testing: Zero performance benchmarks exist.
#      - PRD targets: <200ms UI, <2s submission ack, <3s report render
#      - Need capacity planning: ~150 tenants, 1500 users estimated from revenue targets
#   8. TypeORM synchronize:true must be replaced with migrations
#   9. CI/CD pipeline (Story 1.11)
#
# AFTER MVP Delivery (Epics 1-7 + 7P complete):
#   1. Implement Husky git pre-push hook (nx affected:test + nx affected:lint).
#      Rationale: BMAD workflow already runs full lint/test/build on every story,
#      but Husky adds a safety net for any future non-BMAD pushes.
#
# DEFERRED DECISIONS:
# ===================
# - Story 1.11 (CI/CD) checkpoint after Epic 4. GitHub Actions + nx affected:test/lint/build
#   + Jest --coverage with thresholds + npm audit. Depends on Google Cloud billing (cofounder).
#   If billing not ready after Epic 4, continue with Epic 5 first. TEA review confirmed: 1400+
#   tests = NOW is the right time for automated CI/CD pipeline.
# - Story 1.12 (Invitations) story created, ready-for-dev. Not blocking Epic 2/3.
# - MVP runs entirely on laptop: Angular + NestJS + Postgres (Docker) + Redis (Docker) + Vertex AI API key.
# - synchronize:true for dev. Switch to TypeORM migrations before production deployment.
# - Production infrastructure decisions (cloud provider, file storage, secrets, backups)
#   now tracked in Epic 7P (created 2026-02-05 from Architect Review findings).
#
# DEFERRED TO PHASE 2: KNOWLEDGE BASE FEATURES (Epic 3 Retro Item #8)
# ====================================================================
# Decision: Knowledge base features (RAG, semantic search integration with workflows)
# are deferred to Phase 2. This includes:
#   - Wizard knowledge step (removed from workflow-wizard.component.ts)
#   - Knowledge source selection UI for workflows
#   - RAG-powered workflow inputs
# The backend code (Stories 2-2, 2-3, 2-4) remains intact but is not used in MVP.
# Workflows will use file uploads from Data Vault as inputs, not RAG search.
# Raised during Epic 3 retrospective (2026-02-04).
#
# DEFERRED: DEFENSE-IN-DEPTH HARDENING
# =====================================
# Story 2.4 code review (M3): Some raw SQL queries (e.g., getByRun) rely on RLS alone
# for tenant scoping without explicit tenant_id in WHERE clause. While safe due to RLS,
# adding explicit tenant_id provides defense-in-depth. This should be applied holistically
# across ALL raw SQL in the codebase (knowledge-search, validated-insight, ingestion)
# as a dedicated hardening story rather than piecemeal. Add to Epic 7 or a future
# hardening sprint.
# Raised during Story 2.4 code review (2026-02-01).
#
# RETRO NOTE: RECURRING tenantId OMISSION IN WHERE CLAUSES
# =========================================================
# This is a RECURRING pattern across multiple stories and epics:
# - Story 2.4 code review: raw SQL queries missing tenant_id (M3)
# - Story 3.3 code review: H3 — findOne queries missing tenantId defense-in-depth
# - Story 3.4 code review: H1/H2 — WorkflowVersionsService had THREE methods missing
#   tenantId in WHERE clauses (createVersion, findAllByTemplate, findOne)
# ROOT CAUSE: Dev agent consistently writes queries with only the primary key (id)
# and omits tenantId from WHERE clauses, relying on RLS alone. Code review catches
# it every time, but it should not be happening in the first place.
# ACTION: This pattern must be added to project-context.md as a CRITICAL rule so
# that dev agents include tenantId in EVERY WHERE clause by default. The rule should
# be: "ALL TypeORM findOne/find/update/delete WHERE clauses on tenant-scoped entities
# MUST include tenantId alongside any other conditions. No exceptions."
# Raised during Story 3.4 code review (2026-02-02).

# RETRO NOTE: END-TO-END TEST COVERAGE IS ZERO
# ==============================================
# Despite 555+ unit tests passing across all projects, the UI is largely
# non-functional in the browser. Root causes discovered during Story 3.2 review:
#
# 1. UNIT TESTS MOCK EVERYTHING: All HTTP calls use provideHttpClientTesting()
#    or jest mocks. Tests verify component logic in isolation but never hit
#    a real API. 555 tests can pass while the actual app returns 500 on every endpoint.
#
# 2. API GATEWAY CRASHES ON STARTUP: TypeORM entities (WorkflowRunEntity,
#    WorkflowChainEntity, KnowledgeChunkEntity) were never registered via
#    forFeature(), so autoLoadEntities:true never created their tables.
#    RlsSetupService crashes trying to enable RLS on missing tables.
#    This was NEVER caught because no e2e or integration test starts the server.
#
# 3. CIRCULAR DEPENDENCY IN LAZY ROUTES: unsaved-changes.guard.ts statically
#    imported HasUnsavedChanges from workflow-wizard.component.ts, breaking
#    Vite's chunk splitting. The "Create Workflow" button silently failed.
#    Unit tests don't test lazy loading or chunk resolution.
#
# 4. SETTINGS PAGE DOESN'T EXIST: Navigation sidebar links to /admin/settings
#    but no route or component exists. Zero tests catch this because no e2e
#    test exercises navigation.
#
# ACTION REQUIRED: Create end-to-end tests starting from Epic 1 for ALL epics.
# E2E tests must verify:
#   - API gateway starts without errors
#   - All navigation routes resolve to real components
#   - API endpoints return expected responses (not just 500)
#   - Authentication flow works end-to-end
#   - CRUD operations complete round-trips (UI → API → DB → API → UI)
#
# QUALITY PROCESS FAILURES:
#   - "MVP quality" was used as an excuse to skip integration testing
#   - 81 lint warnings were hidden across the codebase (Epic 1)
#   - Step validation in workflow wizard was completely bypassed (nextStep(true)
#     hardcoded) — equivalent to "forgot to implement a story"
#   - Entity registration gaps went undetected for 3+ epics because unit tests
#     never exercise the TypeORM connection
#
# ADDITIONAL PRE-EXISTING ISSUE: PGVECTOR COLUMN TYPE WRONG SINCE EPIC 2
# The knowledge_chunks.embedding column was created as float8[] (TypeORM default)
# instead of vector(768) (pgvector type). This means:
#   - HNSW index for fast cosine similarity search was NEVER created
#   - All similarity searches do sequential scans (O(n) instead of O(log n))
#   - The warning "operator class vector_cosine_ops does not accept data type
#     double precision[]" appeared on EVERY server startup and was ignored
# Fix applied: RlsSetupService now ALTERs the column to vector(768) on startup.
# This was never caught because:
#   a) Unit tests mock the database
#   b) No integration test verifies actual pgvector queries
#   c) The search "worked" (PostgreSQL casts on-the-fly) so nobody noticed
# Raised during Story 3.2 UI testing (2026-02-02).
#
# This is the #1 priority action item for the retrospective.
# Raised during Story 3.2 code review and UI testing (2026-02-02).
#
# RETRO NOTE: LOGOUT BUTTON UX — TEMPORARY PLACEHOLDER
# =====================================================
# Current logout button in admin sidebar footer is a plain text button.
# Planned redesign: replace with user avatar dropdown menu (click avatar → dropdown
# with profile info, settings, and logout). This should apply to ALL layout components
# (admin-layout and app-layout) for all user roles (bubble_admin, tenant users).
# The current ugly standalone button should be removed once the avatar dropdown is built.
# Raised during Story 3.2 UI testing (2026-02-02).
#
# RETRO NOTE: ADDITIONAL RUNTIME BUGS FOUND DURING UI TESTING
# ============================================================
# 1. Tags input comma bug: metadata step's ngOnChanges → populateFromState() re-patched
#    the tags form control from parent state on every keystroke. Since syncToParent()
#    splits on comma and filters empty strings, typing a comma immediately triggers
#    a round-trip that strips the trailing comma. User could never type commas.
# 2. Markdown output sections error: "Cannot find control with name: '0'" —
#    formArrayName="sections" was missing on the sections container div.
#    [formGroupName]="i" tried to resolve against root form group instead of FormArray.
# Both bugs were invisible to unit tests (mocked forms, no real DOM interaction).
# Raised during Story 3.2 UI testing (2026-02-02).
#
# END-OF-EPIC DISCUSSION ITEMS (collected during Epic 3 UI testing)
# =================================================================
# The following items were raised by the user during hands-on UI testing and
# must be discussed at the end of this epic for planning/prioritization:
#
# 1. LOGOUT BUTTON UX: Replace standalone text button with user avatar dropdown
#    menu. Applies to all layouts (admin + app) and all roles.
#
# 2. WORKFLOW VISIBILITY UI: Backend supports public/private/restricted +
#    allowed_tenants, but the workflow wizard has no UI for these fields.
#    Need to add visibility controls to the wizard or a separate management view.
#
# 3. TENANT LIFECYCLE: Add archive/suspend state for churned tenants.
#    Add hard-delete option for archived tenants (GDPR/data privacy compliance).
#    Currently only create/read/update exists — no archive or delete.
#
# 4. SETTINGS PAGE (REQUIRED): Admin Settings page must be built. Key features:
#    - LLM model management: add new models to existing providers, edit/deactivate
#      models, configure provider credentials (Google AI Studio, Vertex, etc.)
#    - System-level configuration (future: email templates, feature flags, etc.)
#    The nav link was removed because it pointed to 404 with no backing component.
#    Must be re-added once the settings feature is implemented.
#
# 5. E2E TEST COVERAGE: Create end-to-end tests starting from Epic 1 for all
#    epics. This is the #1 priority action item (see detailed note above).
#
# 6. STORY SIZING: Story 3.2 was too large (6-step wizard + all UI components),
#    leading to many bugs and extended review cycle. Enforce smaller, more
#    focused stories going forward to reduce risk and improve quality.
#
# 7. UI POLISH PASS: Several UI components look rough/ugly. Need a dedicated
#    polish pass to improve visual consistency, spacing, and overall UX.
#
# 8. KNOWLEDGE BASE INTEGRATION UX: The wizard has a knowledge toggle step but
#    we haven't designed how users actually attach/select knowledge sources to
#    a workflow. Need to define the UX for linking indexed assets to workflows.
#
# 9. WORKFLOW WIZARD DOCUMENTATION: Create a user guide explaining each wizard
#    step, field names, variable syntax ({subject_name}, {timestamp}, etc.),
#    input roles (subject vs context), and expected values so the product can
#    be properly tested end-to-end.
#
# Raised during Story 3.2 UI testing (2026-02-02, 2026-02-04).
#
# RETRO NOTE: QUALITY REGRESSION SINCE EPIC 2 RETROSPECTIVE
# ==========================================================
# Despite the Epic 2 retrospective identifying process failures and defining
# action items, quality has REGRESSED rather than improved. Examples from
# Story 3.6b review (2026-02-04):
#
# 1. SHALLOW ANALYSIS: When reviewing Story 3.6b, suggested deferring AC 14
#    (intermediate outputs visibility) without analyzing the business impact.
#    This feature is CRITICAL for fairness — users pay credits for each workflow
#    in a chain and MUST see all outputs they paid for. Deferral was lazy, not
#    a legitimate scope decision.
#
# 2. ROUTE INCONSISTENCY: Story specified `/admin/workflow-studio/chains/new`
#    but existing routes use `/admin/workflows/`. Basic codebase verification
#    was not performed before writing the story.
#
# 3. INTERFACE MISMATCH: Story task listed input source options that don't match
#    the actual ChainInputSource interface. Copy-paste assumptions instead of
#    reading the actual code.
#
# 4. MISSING DEPENDENCIES: Story required fetching published templates but
#    WorkflowTemplateService.getAll() doesn't exist. Dependencies not verified.
#
# ROOT CAUSE: The agent is optimizing for speed over correctness. Story creation
# is becoming a checkbox exercise rather than thorough technical analysis.
# The user should NOT have to babysit every decision.
#
# ACTION REQUIRED:
# - Story review must include VERIFICATION against actual codebase (routes,
#   interfaces, services, DTOs) before marking ready-for-dev
# - "Defer" recommendations require explicit business impact analysis
# - Quality bar from Epic 2 retro MUST be enforced, not ignored
#
# Raised during Story 3.6b review (2026-02-04).

# ARCHITECT REVIEW FINDINGS (2026-02-05)
# =======================================
# A comprehensive Architect Review Package was generated scanning ALL BMAD docs,
# the full codebase, and all planning artifacts. Seven critical production-readiness
# gaps were identified and captured in Epic 7P (Production Readiness):
#
# CRITICAL (blocks production deployment):
#   1. NO DEPLOYMENT TARGET: Only local docker-compose exists. No cloud provider chosen.
#      Architecture.md mentions Render/Railway/AppRunner but no decision made. GCP implied
#      by Vertex AI/Gemini dependency. This decision cascades to ALL other infra choices.
#   2. NO FILE STORAGE STRATEGY: Uploaded files stored on local disk (uploads/<tenantId>/).
#      Lost on container restart. No horizontal scaling. No backup. Not production-safe.
#   3. NO SECRETS MANAGEMENT: 6 sensitive env vars in .env files. No rotation, no encryption
#      at rest, no audit trail. Cloud secrets manager required.
#   4. NO BACKUP/DR: docker compose down -v destroys everything. No pg_dump, no PITR,
#      no file backup. Knowledge Base snapshots deferred as [Future] in architecture.
#
# HIGH (blocks safe Epic 4 execution):
#   5. NO ERROR HANDLING STRATEGY: BullMQ ingestion has basic retry (3 attempts, exp backoff)
#      but no DLQ, no circuit breaker, no alerting. Before Epic 4 (real LLM calls with
#      credit charges), need idempotency + failure recovery for charged operations.
#   6. RLS AUTH BYPASS RED FLAG: auth_select_all on users table uses condition:true.
#      Any DB connection without tenant context can read ALL users (emails, password hashes).
#      Intentional for pre-auth flow but needs formal security review and risk acceptance
#      or mitigation (dedicated DB roles).
#   7. NO PERFORMANCE TARGETS VALIDATED: PRD has NFRs (<200ms UI, <2s submission, <3s report)
#      but zero load tests exist. No capacity planning. Revenue target implies ~150 tenants
#      / 1500 users but no infra sizing done.
#
# DOCUMENT: _bmad-output/planning-artifacts/architect-review-package.md
# ACTION: Epic 7P created with 7 stories to address these gaps.
# TIMING: BullMQ safety-critical items (DLQ + idempotency) moved to Story 4.0 (first Epic 4 story).
#         7P-5 (circuit breaker, alerting, monitoring) can run parallel with Epic 4.
#         7P-1 through 7P-4 can run parallel with Epic 4 but must complete before production.
#         7P-6 and 7P-7 can run anytime before production.

# EPIC 3 RETRO: AGREED EXECUTION ORDER (2026-02-08)
# ===================================================
# This is the team-agreed execution plan from the interactive Epic 3 retrospective:
#   1. ✅ Finalize Epic 3 retrospective (done)
#   2. ❌ Story 3.11 — CANCELLED (party mode 2026-02-08: prompt defines structure, LLM returns markdown, report UI renders it)
#   3. ✅ Story MW-1 — Module wiring tests for Epics 1, 2, 3 (done — 40 tests, code review: 7 fixes, 1028 total)
#   4. ✅ Run wiring tests, fix any issues found (done)
#   5. ✅ Story 3E update — rewrite: 12→17 tests, 5 spec files (done — wizard fix + validation + template library)
#   6. ✅ Story 1E update — rewrite: 7→13 tests, 5 spec files (done — tenant lifecycle + RBAC)
#   7. ✅ Story 2E update — rewrite: 11→13 tests, 5 spec files (done — invitations)
#   8. ✅ Run full E2E suite, fix any issues found (done — 46/46 E2E tests pass, 11 failures fixed across 3 sessions)
#   9. ✅ Epic 4 planning party mode — 9 topics decided, document saved (done — 2026-02-09)
#   10. ✅ Story 4-0 — BullMQ DLQ + idempotency (done — 19 new tests, 1047 total)
#   11. ✅ Story 4-1 — Workflow Catalog + Run Initiation (done — 979 unit + 46 E2E)
#   12. ✅ Story 4-2 — LLM Provider Interface + Prompt Assembly (done — 1044 unit tests)
#   13. ✅ Story 4-3 — Execution Engine Core Fan-Out/Fan-In (done — tagged v0.4.3)
#   14. ✅ Live Test Round 1 with erinc — 16 issues found (3C + 6H + 7M), party mode triage (done — 2026-02-12)
#   15. Story 4-FIX-A1 — RETURNING engine fixes (C1 fan-in bug, Tier 2 wiring test, audit all RETURNING, update mocks, orphaned run cleanup)
#   16. Story 4-FIX-A2 — Lifecycle UI/API fixes (C2 publish, C3 catalog findPublishedOne + RLS policy, H2 duplicate hash, H5 accept, H6 redirect)
#   17. Story 4-FIX-B — Admin UI & settings fixes (H1 provider cascade, H3 data vault render, H4 users endpoint, M1 bulk activate, M2 default private)
#   18. ✅ Live Test Round 2 — agent + erinc validation of all fixes (done — 5/5 verified, 2 new findings, 1 build fix)
#   18b. Story 4-TESTFIX-LT2 — Live Test Round 2 fixes (impersonation role mapping + Lucide icons)
#   19. ✅ Story 4-RLS-A/B/C — Full RLS enablement trilogy (done — 1275 total tests, auth policy tightened)
#   20. ✅ Story 4-TESTFIX-RLS — SKIPPED (all tests pass after RLS, not needed)
#   21. ✅ Live Test Round 3 — zero issues found (2026-02-15)
#   22. ✅ Story 4-SA-A — Production Support Access (backend audit trail — JWT fix, audit tables, mutation logging) (done — 1267 tests, 3-pass review: 10 fixes)
#   23. ✅ Story 4-4 — Credit Management (pre-flight validation + credit check) (done — 1344 tests, 3-pass review: 17 fixes)
#   24. ✅ Story 4-SA-B — Production Support Access (frontend — JWT 2h, graceful 401, inactivity pre-warning, customer access log page) (done — 1372 tests, 3-pass review: 21 findings)
#   25. ✅ Story 4-PR — Provider Registry (backend-driven, replaces hardcoded constants) (done — 1400 tests, 3-pass review: 18 findings all fixed)
#   26. Story 4-GP — LLM Generation Parameters (two-tier config: model defaults + per-workflow overrides)
#   27. Story 4-fix — TransactionManager bypass fix + soft-delete audit + regression integration tests (Rule 32: fix now)
#   28. Story 4-tier3 — API Contract Tests infrastructure (supertest, real DB, ~50 admin endpoint tests)
#   29. Story 4-H1 — Model Reassignment UX (warning dialog + per-workflow dropdown when provider deactivated)
#   30. Story 4-5 — Output Validation & Storage
#   31. Story 4-6 — Workflow Chain Orchestration
#   32. Story 4-7 — Workflow Test Run Preview (layout preview + functional test run)
#   33. Story 4-test-gaps — Error Path Coverage (onFailed catch, magic numbers)
#   34. Story 4-factory — Test Data Factory Library (@faker-js/faker, build*() + adversarial seed scenarios)
#   35. Story 4E — E2E Test Coverage for Epic 4 (depends on 4-factory)
#   36. Story 4EH — E2E Error Path Hardening (cross-epic)
#   37. Live Test Round 4 (Real LLM) — erinc end-to-end test with real Google AI Studio provider + real workflow
#   38. Epic 4 Retrospective (mandatory — 8 agenda items queued)
#   --- CHECKPOINT: CI/CD Pipeline (Story 1.11) ---
#   37. Story 1.11 — CI/CD Pipeline Setup (GitHub Actions + nx affected + Jest --coverage + npm audit)
#       NOTE: Depends on Google Cloud billing (cofounder). If not ready, defer to after Epic 5.
#   38. Epic 5 — Interactive Reporting & Feedback Loop
#   Convention: XE = E2E tests for Epic X. Tests written after epic features are built.
#
# LIVE TEST ROUND 1 FINDINGS (2026-02-12 — party mode triage):
# =============================================================
# 16 issues found during first end-to-end live test with erinc.
# Split into two fix stories by domain:
#
# 4-FIX-A1 (RETURNING Engine — 6 tasks):
#   C1: Fan-in RETURNING result parsing (processor.ts:208-217, 388-394) — pg driver returns [[rows], count]
#   Tier 2 wiring test for RETURNING query (Rule 31 — test FIRST)
#   Audit ALL manager.query() RETURNING calls across codebase
#   Update unit test mocks to match real pg RETURNING behavior
#   Orphaned run cleanup SQL + operations runbook
#
# 4-FIX-A2 (Lifecycle UI/API — 10 tasks):
#   C2: Publish/Unpublish buttons missing from workflow settings modal
#   C3: Catalog findPublishedOne + RLS policy (Option A: dual policy, Rule 2c exception)
#   H2: Duplicate hash 409 → return existing asset (HTTP 200)
#   H5: Double-dot accept attribute in file input
#   H6: Remove auto-redirect after run submission (setTimeout removal)
#   Documentation updates (project-context.md, operations runbook)
#   Browser smoke test (Rule 26)
#
# 4-FIX-B (Admin UI — 5 items):
#   H1: Provider deactivation doesn't cascade to models
#   H3: Data vault list doesn't render immediately (Angular change detection)
#   H4: Admin users endpoint doesn't show all users for tenant
#   M1: No bulk activate/deactivate for model groups
#   M2: Models default public, should be private
#
# Deferred to planned work:
#   M3: Provider types hardcoded → Story 4-PR (between Epic 4 and Epic 5)
#   M4: Data vault list view ugly → Epic 5 / 7-7 UI polish pass
#   M5: Can't select vault files when running workflow → Epic 5 (run form UX)
#   M6: "Learn this" button → Phase 2 (knowledge base)
#   M7: Data vault drag-drop file management → Epic 5 (data vault UX)
#   H6 redirect: Status view component → Epic 5 Story 5-1 (report dashboard)
#
# New rules from this session:
#   Rule 31: Raw SQL RETURNING wiring test requirement
#   Rule 32: Fix now unless planned (no "investigate later" bucket)
#
# KEY TEAM AGREEMENTS (new from Epic 3 retro):
#   - Party mode is DEFAULT for every story (planning, post-impl, code review)
#   - Module wiring tests are a standard test category for all epics
#   - Story size limit: max ~60 tests per story
#   - TenantId enforcement: automated grep/CI check + code review checklist
#   - Guard ordering documentation required for every guard
#   - Browser smoke test for every UI story before code review
#   - Story creation must verify actual codebase state
#   - Prompt is single source of truth for workflow output structure

# IMMEDIATE POST-EPIC-2 ACTION:
# =============================
# - Swagger @ApiResponse gap fix: Add missing error response decorators (400, 401, 403, 500)
#   to ALL existing controllers across Epic 1 and Epic 2. Rule added to project-context.md
#   to prevent this gap in all future epics. Must be done before Epic 3 starts.
#   Controllers to fix: AuthController, TenantsController, UsersController,
#   InvitationsController, AssetsController, FoldersController, IngestionController,
#   KnowledgeController, AppController.
#   Raised during Story 2.3 code review (2026-02-01).
#
# FUTURE EPIC CONSIDERATION:
# ==========================
# - Knowledge Base Browsing/Viewing UI: Admin and tenant-facing UI to browse stored
#   RAG data (indexed chunks, embeddings metadata), search the knowledge base interactively,
#   and view per-tenant knowledge health. Could be part of Epic 8 or a new epic.
#   Raised during Story 2.3 creation (2026-02-01).

generated: 2026-01-30
project: project_bubble
project_key: bubble
tracking_system: file-system
story_location: stories

development_status:
  # ═══════════════════════════════════════════════════════
  # Epic 1: Tenant Management & Platform Setup
  # FRs: FR30, FR33, FR26, FR27, FR28, FR32, FR51
  # ═══════════════════════════════════════════════════════
  epic-1: done
  1-1-monorepo-infrastructure-initialization: done
  1-2-tenant-provisioning-api: done
  1-3-bubble-admin-dashboard-the-lobby: done
  1-4-impersonation-action: done
  1-5-tenant-configuration-credits-entitlements: done
  1-6-tenant-seeding-templates: skipped # FR51 obsoleted by workflow-centric visibility (Epic 3 design decision)
  1-7-user-authentication-rbac: done
  1-8-rls-enforcement-mechanism-security: done
  1-9-user-management-admin-creation: done
  1-10-login-password-pages-auth-ui: done
  1-11-ci-cd-pipeline-setup: deferred # CHECKPOINT: After Epic 4 completion, set up CI/CD (GitHub Actions + nx affected:test/lint/build + Jest --coverage with thresholds + npm audit). Dependency: Google Cloud billing account (cofounder). If billing not ready, continue with Epic 5 first, do CI/CD after. Includes coverage measurement (coverageThreshold enforcement).
  1-12-user-invitations-email-flow: done
  1-13-tenant-lifecycle-management: done # Archive/suspend/delete tenants + TenantStatusGuard. Code review: 7 findings (1H, 3M, 3L), party mode: 5 fixed, 1 deferred (Epic 4), 1 dismissed. 880 total tests, 0 lint errors.
  epic-1-retrospective: done
  epic-1-nfr-assessment: done # NFR assessment completed 2026-01-31, FAIL status, hardening story required
  1e-e2e-test-coverage-epic-1: done # Comprehensive rewrite: 13 tests across 5 spec files (7 existing + 6 new). Tenant CRUD, lifecycle (suspend/unsuspend/archive/unarchive/hard-delete), RBAC (non-admin blocked, suspended tenant blocked), auth guard. Code review: 5 findings fixed (F1-F5). 10 data-testid additions. 1028 unit tests, 0 lint errors.

  # ═══════════════════════════════════════════════════════
  # Epic 1H: Security & Reliability Hardening
  # Cross-cutting fixes from NFR assessment (2026-01-31)
  # Must complete before Epic 2 starts
  # ═══════════════════════════════════════════════════════
  epic-1h: done
  1h-1-security-reliability-hardening: done # All 7 tasks done, code review passed, 237 tests passing

  # ═══════════════════════════════════════════════════════
  # Epic 2: Asset & Knowledge Management
  # FRs: FR23, FR48, FR3, FR21, FR22
  # ═══════════════════════════════════════════════════════
  epic-2: done
  2-1-asset-management-tenant-shared-drive: done
  2-2-vector-ingestion-reference-assets: done
  2-3-semantic-search-service-vector-rag: done
  2-4-validated-insight-storage-memory: done # Code review passed, 406 tests, 0 lint errors
  epic-2-retrospective: done # Retrospective completed 2026-02-01. 3 critical process failures documented. Action items defined.
  2e-e2e-test-coverage-epic-2: done # Comprehensive rewrite: Data Vault (folders, files, upload, tenant isolation) + Settings LLM Admin + Invitation management (dialog + list/revoke). 13 tests, 5 spec files, 3 auth states, hybrid seed + DB seeding for invitations. 1028 unit tests, 0 lint errors.

  # ═══════════════════════════════════════════════════════
  # Pre-Epic-3 Gates
  # ═══════════════════════════════════════════════════════
  gate-swagger-api-response: done # All 11 controllers, 42 endpoints documented. 406 tests, 0 errors.
  gate-workflow-definition-schema: done # Tech spec approved 2026-02-02. 12 tasks, 13 ACs, 20 technical decisions. Party mode DB review complete (10 findings applied).

  # ═══════════════════════════════════════════════════════
  # Epic 3: Workflow Definition (Atomic Workflows, Chains, Wizard)
  # FRs: FR1, FR2, FR4, FR5, FR6, FR35, FR42
  # REWRITTEN 2026-02-02: All stories updated for party mode architectural pivot.
  # Old node-based stories (3.1-3.6 + 3.2b) replaced with atomic workflow architecture.
  # ═══════════════════════════════════════════════════════
  epic-3: done # All 12 stories + hardening + E2E + retro complete. 880 total tests, 0 lint errors.
  3-1-workflow-definition-data-foundation: done # Code review passed, 7 fixes applied, 453 tests, 0 lint errors
  3-2-workflow-builder-wizard-admin-ui: done # Code review passed (17 fixes), UI testing fixes applied, final review 2026-02-04. 575+ tests, 0 lint errors.
  3-3-workflow-template-crud-api: done # Code review passed, 6 fixes applied (H1-H3, M1-M2, L1), 504 tests, 0 lint errors
  3-4-workflow-versioning-publishing: done # Code review passed, 6 fixes applied (H1-H2, M1-M3, L1), 530 tests, 0 lint errors
  3-5-workflow-visibility-access-control: done # Code review passed, 5 fixes applied (H1, M1-M3, L1), 539 tests, 0 lint errors
  3-6a-workflow-chain-crud-api: done # Code review passed, 52 tests (24 validator + 21 service + 7 controller), 432 total tests, 0 lint errors
  3-6b-workflow-chain-builder-ui: done # Code review passed 2026-02-04, 8 fixes applied (H1-H2, M1, M3-M4, L1), 228 tests, 0 lint errors
  3-7-workflow-studio-template-library: done # Code review passed 2026-02-04, 9 fixes applied (7 issues + takeUntilDestroyed), 291 tests, 0 lint errors.
  3-8-workflow-management-view: done # Settings modal for visibility, tenants, archive/unarchive. Party mode review: 10 findings, all fixed. 49 story tests. 823 total tests, 0 lint errors.
  3-9-workflow-wizard-documentation-tooltips: done # 12 tooltips added across 5 wizard step files. Code review: 3 findings fixed (M1, M2, L1 — consolidated section tooltips to group label). 878 tests, 0 lint errors.
  3-10-file-type-preset-groups: done                   # UX-1 from user testing feedback. Chip-toggle presets for wizard file type restrictions. Code review: 7 findings (6 fixed). 19 new tests. 944 total tests, 0 lint errors.
  3h-rxjs-subscription-cleanup-hardening: done # Code review passed. 37 subscriptions fixed (19 files). ESLint plugin installed. 291 tests, 0 lint errors.
  3e-e2e-test-coverage-epic-3: done # Full rewrite: 17 tests, 5 spec files. Wizard fix + validation + variable chips + template library (search/filter/duplicate). Step 8: 46/46 E2E pass. 1028 unit tests, 0 lint errors.
  3-11-prompt-to-output-auto-population: cancelled      # CANCELLED (party mode 2026-02-08): Prompt defines output structure via markdown instructions → LLM returns formatted markdown → report UI renders it. Output sections in wizard are unnecessary. Output step hidden from wizard UI. Validator relaxed (output optional).
  mw-1-module-wiring-tests: done                          # 40 wiring tests (11 Tier 1 + 18 Tier 2 + 11 Angular) + tenantId CI check + shared DB helpers. Code review: 7 findings fixed (ARCHIVED guard, real cross-module verification, DI-resolved guards, shared DB helpers, NODE_ENV comment, icon source-of-truth, test count). 1028 total tests, 0 lint errors.
  epic-3-retrospective: done # Interactive retro completed 2026-02-08. 10 key learnings, 7 mandatory action items, 8 new team agreements. Party mode is default. Module wiring tests are standard.

  # ═══════════════════════════════════════════════════════
  # Epic 3.1: Settings & Essentials
  # Foundational infrastructure needed before proceeding
  # Created from Epic 3 retrospective: Settings + Logout
  # Must complete before E2E test stories and Epic 4
  #
  # REWRITTEN 2026-02-05: Original 3.1-1 failed quality review (no codebase
  # verification, scope too large, invented non-existent env vars). Split into
  # 3 properly-scoped stories. Existing LLM model backend (entity, service,
  # controller, DTOs) was not referenced — Story 3.1-3 builds frontend for it.
  #
  # DEFERRED FROM ORIGINAL 3.1-1:
  #   - Test Connection → Epic 4 (needs LLM provider SDK integration)
  #   - Audit Trail → Epic 7 Story 7-2 (cross-cutting concern)
  #   - E2E Tests → Handled by E2E stories (1E/2E/3E)
  # ═══════════════════════════════════════════════════════
  epic-3.1: done # All 4 stories complete (3.1-1 through 3.1-4). 878 total tests, 0 lint errors.
  3.1-1-admin-settings-page-shell: done # REWRITTEN 2026-02-05. Settings page route + tabbed layout + nav link. UI skeleton only.
  3.1-2-logout-avatar-dropdown: done # Avatar dropdown replaces logout in all layouts. GET /api/auth/me + user signal + reusable AvatarDropdownComponent. 28 tests, code review passed (2 rounds).
  3.1-3-llm-model-admin-ui: done # Frontend for existing backend LLM model CRUD. 29 tests, 353 total. Code review passed 2026-02-06.
  3.1-4-provider-credential-storage: done # LlmProviderConfigEntity + encrypted credential storage + CRUD API + Providers tab UI. 70 story tests. Code review: 8 fixes (3H, 3M, 2L). 878 total tests, 0 failures, 0 lint errors.

  # ═══════════════════════════════════════════════════════
  # USER TESTING FEEDBACK (2026-02-08 — post-Story-3.9 live session)
  # Captured during hands-on browser testing of the full app.
  # Party mode review completed 2026-02-08.
  # ═══════════════════════════════════════════════════════
  #
  # BUG-1: TEMPLATE RENDERING BROKEN (Settings + Workflow Studio) — FIXED
  #   Root cause: 20 missing Lucide icon registrations in app.config.ts.
  #   Unregistered icons silently broke Angular template rendering.
  #   Fix: commit b30faa3. All icons now registered.
  #
  # BUG-2: EMAIL INVITATIONS FAIL (expected)
  #   Root cause: No SMTP service configured. Expected for local dev.
  #   Target: Epic 7P or production deployment setup.
  #
  # UX-1: FILE TYPE RESTRICTIONS — MANUAL ENTRY TOO TEDIOUS → Story 3.10
  #   Decision: Standalone story (not part of 3.8). Chip-toggle UI with
  #   hardcoded preset groups. Shared constant in libs/shared. ~half day.
  #
  # UX-2: NO PUBLISH UI — covered by Story 3.8 (no separate action needed)
  #
  # FEATURE-1: WORKFLOW TEST RUN & PREVIEW → Story 4.7 (Epic 4)
  #   Decision: Both layout preview (A) and functional test (B) deferred to
  #   Epic 4. The test run form IS the user-facing form — Option A comes free.
  #   Option B requires the execution engine. No throwaway preview UI.
  #
  # BUGS FIXED IN THIS SESSION:
  #   - tenant_id → tenantId mismatch in 8 controllers (commit 74ab37a)
  #   - SET LOCAL parameterized query → string interpolation with UUID validation
  #   - Role tooltip clarified (Subject vs Context)
  #   - 20 missing Lucide icons registered (commit b30faa3)
  #

  # ═══════════════════════════════════════════════════════
  # Epic 4: Workflow Execution Engine (The Creator)
  # FRs: FR7-FR13, FR34, FR36, FR37, FR46, FR47
  # REWRITTEN 2026-02-02: Updated for LLM-orchestrated execution, fan-out/fan-in, chain orchestration.
  # ═══════════════════════════════════════════════════════
  epic-4: in-progress
  4-0-bullmq-safety-prerequisites: done                # DLQ routing + idempotency keys + workflow execution queue. 18 unit + 1 wiring = 19 new tests. Code review: 3 findings fixed.
  4-1-workflow-catalog-run-initiation: done                    # 10 tasks + code review (8 findings fixed: signal reactivity, ValidateNested Record fix, creditsPerRun wizard field, setTimeout cleanup, max_size_mb enforcement). 979 unit tests, 46 E2E pass, 0 lint errors.
  4-2-llm-provider-interface-prompt-assembly: done            # 10 tasks, code review: 7 findings fixed (H1 cache key collision, M2 DTO null validation, M3 subject file warning, M4 test cleanup, M1 file list, L1+L2 minor). 1044 unit tests (550 api + 494 web), 0 lint errors. Key: UUID model binding, provider factory with updatedAt cache, TextExtractorService for PDF/DOCX, MockLlmProvider.
  4-3-execution-engine-core-fan-out-fan-in: done            # Fan-out (N jobs for parallel) + fan-in (1 job for batch) + COMPLETED_WITH_ERRORS status + per-file results + run aggregation. 7 tasks. Code review: 3 passes (Amelia + Naz + Murat), 8+5 findings all fixed. Tagged v0.4.3.
  4-fix-a1-returning-engine-fixes: done                     # Live test round 1 — CRITICAL: C1 fan-in RETURNING bug (pg driver [[rows], count] destructuring), Tier 2 wiring test (Rule 31), audit all RETURNING calls, update unit test mocks, orphaned run cleanup. 3-pass code review complete (Amelia + Naz + Murat), 585 tests, 46 E2E pass.
  4-fix-a2-lifecycle-ui-api-fixes: done                     # Live test round 1 — CRITICAL: C2 publish button, C3 catalog findPublishedOne + RLS policy (Rule 2c exception), H2 duplicate hash 409→200, H5 double-dot accept, H6 remove auto-redirect. 3-pass code review complete (Amelia + Naz + Murat), 6 findings fixed. 1214 total tests.
  4-fix-b-admin-ui-settings-fixes: done                      # Live test round 1 findings — admin UI: H1 runtime guard (simple), H3 data vault zoneless CD, H4 admin users endpoint, M1 bulk activate/deactivate, M2 models default inactive. 3-pass code review complete (Amelia + Naz + Murat). 1237 total tests.
  4-testfix-live-test-round-2-fixes: done                    # Live test round 2 findings — 2 fixes: (1) impersonation role mapping in RolesGuard, (2) Lucide File+FileType icons. 3-pass code review: 0 findings. 1244 total tests.
  4-rls-a-role-dual-datasource-admin-bypass: done             # RLS Part 1/3: bubble_app role + grants + DEFAULT PRIVILEGES, dual DataSource (MigrationDatabaseModule + app), admin bypass in TransactionManager, ALL policy updates (NULLIF + admin bypass + WITH CHECK). Absorbs 7P-6 scope.
  4-rls-b-bullmq-validation: done                             # RLS Part 2/3: BullMQ tenantId defensive validation in process() + onFailed(). 3-pass code review: Pass 2 (10 findings, party mode), Pass 3 (10 findings, 4 fixed). 1181 total tests.
  4-rls-c-test-infra-verification: done                     # RLS Part 3/3: test-db-helpers + global-setup (SHARED INFRA), 7 new Tier 2 wiring tests for RLS enforcement, write isolation, auth_insert_users role restriction. 3-pass code review + post-review auth policy tightening. 1275 total tests.
  4-testfix-rls-test-suite-fixes: skipped                  # Not needed — all tests (unit + wiring + E2E 46/46) pass after RLS enablement. Live Test Round 3 found zero issues.
  4-sa-a-production-support-access-backend: done              # Backend audit trail: JWT attribution fix (real admin UUID), support_access_log + support_mutation_log entities, SupportAccessService (migration DS), mutation interceptor, session end endpoint, 30m token expiry, magic string extraction. 3-pass code review: 10 fixes (6 P1 + 2 P2 + 2 P3). 1267 total tests.
  4-sa-b-production-support-access-frontend: done              # Frontend: JWT 30m→2h, graceful 401 handling, inactivity pre-warning, customer access log page, error state UI. 3-pass code review: 21 findings (13 fixed, 6 tracked, 2 rejected). 1372 total tests.
  4-4-pre-flight-validation-credit-check: done               # Two-pool credit model (monthly+purchased), monthly-first deduction, SELECT FOR UPDATE atomicity, model/provider pre-flight, refund on FAILED, test run bypass. 3-pass review: 6+13+4 findings (17 fixed, 2 tracked, 4 rejected). 1344 total tests.
  4-5-output-storage-retrieval: done                              # Sanity checks, AssetEntity persistence, deterministic filenames, BullMQ immediate retry (3 attempts), granular per-file status, GET endpoints for output retrieval. 3-pass review: Pass 1 (10 findings: 7 fixed, 3 tracked), Pass 2 Naz (7 findings: all fixed, 5 Rule 2c), Pass 3 Murat (5 findings: 4 fixed, 1 tracked). 1596 total tests.
  4-5b-retry-failed-wiring: backlog                              # Wire existing "Retry failed" button (UI from 4-3) to backend: POST /workflow-runs/:id/retry-failed endpoint, credit re-deduction for retried files, fan-in counter re-opening, re-enqueue only failed PerFileResult entries. Origin: 4-5 story review party mode (2026-02-16).
  4-6-workflow-chain-orchestration: backlog
  4-7-workflow-test-run-preview: backlog              # FEATURE-1 from user testing feedback. Combines layout preview + functional test run. Party mode consensus 2026-02-08.
  4-pr-provider-registry-backend-driven: done               # M3 from live test: Self-describing adapter registry replaces 4 hardcoded locations. ProviderRegistry service, factory refactor, service refactor, new endpoint, frontend dynamic form. 3-pass code review: Pass 1 (8 fixes), Pass 2 (6 fixes), Pass 3 (4 fixes). 1400 total tests.
  4-factory-test-data-factory-library: backlog             # Test data factory library using @faker-js/faker. build*() functions for each entity type + ADVERSARIAL seed scenarios: buildDeletedTemplate(), buildCrossTenantPublishedTemplate(), buildDeactivatedModelWithActiveWorkflow(), mixed-status templates per tenant. E2E seed refresh to use builders. Must complete BEFORE 4E. Origin: TEA review (2026-02-16) + party mode systemic test gap (2026-02-16).
  4e-e2e-test-coverage-epic-4: backlog                   # E2E tests for Epic 4 features (execution engine, test runs, output validation). Written AFTER Epic 4 development. Convention: XE = E2E for Epic X. Depends on 4-factory.
  4-fix-browser-imports: done                                # Fix class-transformer crash in browser: 4 import fixes + ESLint rule with typescript-eslint plugin registration + barrel documentation. 3-pass code review: Pass 2 (6 findings: 2 FIX, 4 REJECT), Pass 3 (5 findings: 2 FIX, 1 TRACK in 4-test-gaps, 2 REJECT). 1460 unit + 46 E2E tests pass. Origin: E2E failure investigation (2026-02-16). Rule 32.
  4-fix-published-template-404: done                         # TransactionManager bypassRls fix (if/else if → two independent if) + soft-delete audit (14 withDeleted:false across 4 services) + 14 new unit tests + Tier 2 wiring update. 3-pass code review: N-1/N-2 (doc), M-1 (edge case test). 1474 unit + 46 E2E pass.
  4-tier3-api-infra: done                                     # Story A: API Contract Test infrastructure + P0 endpoint tests (17 tests). supertest + NestJS TestingModule + real DB (project_bubble_contract_test). Dual DataSource (superuser seed, bubble_app app). JWT via JwtService injection. 3-pass review: Pass 1 (4 fixes), Pass 2 Naz (3 fixes: SQL injection, encryption key, missing test), Pass 3 Murat (4 fixes: validation boundary, seed shape, export consistency, unused fixture). 1491 total tests.
  4-tier3-api-coverage: done                                     # Story B: Remaining API contract tests — auth, tenants, LLM settings/models, chains (21 tests). 3-pass code review: Pass 1 (2 fixes), Pass 2 Naz (4 fixes: dead vars, masking structure, bulk toggle cleanup, CT-505 negative test), Pass 3 Murat (2 fixes: login token chain, RlsSetupService doc, 1 withdrawn). 1512 total tests.
  4-test-gaps-error-path-coverage: backlog                   # Tracked from 4-RLS-B Pass 2: onFailed catch block coverage, magic number extraction. Small cleanup story. Also: 4-GP Pass 3 F7 — type-level enforcement of GENERATION_PARAM_KEY_MAP against WorkflowExecution/LLMGenerateOptions interfaces (prevents silently dropped params when adding new generation fields). Also: 4-fix-browser-imports Pass 3 (Murat F5) — explicit E2E test checking for console.error on wizard route (current E2E catches page-blanking crashes but not silent console errors). Also from 4-5 Pass 1: F8 — createFromBuffer MIME type validation (internal API, low risk but defense-in-depth); F10 — makeJob() defaults attemptsMade:3 in processor spec (pre-existing pattern, should default to 0). Also from 4-5: api-contract-b.spec.ts (Tier 3 DB-dependent) fails when included in standard unit test run without PostgreSQL — need graceful skip or separate jest project/config for Tier 3 contract tests.
  4eh-e2e-error-path-hardening: backlog                  # E2E error path tests across ALL epics (1-4). Covers: duplicate name 409, invalid status transitions 400, file upload size limit, network errors, validation error displays. Convention: include 1-2 error paths per spec file in future XE stories.
  4-gp-llm-generation-parameters: done                     # Two-tier config: model defaults (JSONB) + per-workflow overrides. Provider-aware dynamic UI. 3-tier merge utility with clamping. 3-pass code review: 11 fixes total. 1460 total tests (+60 new). 8 E2E failures: 6-7 caused by class-transformer browser crash (tracked in 4-fix-browser-imports), remainder tracked in 4-fix-published-template-404.
  4-h1-model-reassignment-ux: done                            # Model Reassignment UX: blocking dialog on deactivation, mandatory replacement model selection, atomic bulk reassignment + nuclear param reset, N-1 config snapshot for rollback, zero-model guard. 3-pass code review: Pass 1 (1 fix), Pass 2 Naz (7 fixes), Pass 3 Murat (4 fixes, 2 tracked in 4-test-gaps). 1527 unit + 45 E2E tests.
  epic-4-retrospective: optional                               # MANDATORY AGENDA: 13 items queued — (1) Winston quality gate, (2) Rule 36 violation, (3) Rule 11 violation, (4) V7 unilateral rejection (3x in 4-4), (5) bulk task-checking without verification (4-SA-B), (6) systemic procedure-skipping (structural fix needed), (7) code review TRACK without story-id + rules→templates migration (structural gate: mandatory fields in story template for live-bug regression tests, review finding resolution format), (8) systemic test gap: "all tests pass but system broken" (2x occurrence — Epic 3 retro + 4-GP smoke test). TransactionManager design flaw + soft-delete gaps + 4% integration coverage. (9) Party mode agent absence: 2 consecutive rounds with missing agents despite explicit "full team" instruction — structural fix needed for attendance logic. (10) Mary (analyst): 2 fundamental product misunderstandings in single party mode (said users write prompts — prompts are Bubble IP; said customers configure workflows/select templates — customers only upload inputs and click Run). (11) UX-first principle: team chose lazy implementation over better UX (Murat retry discussion) — standing principle: user experience wins unless implementation cost is wildly disproportionate. (12) "Noted for X" without actually tracking: party mode 4-5 made decisions deferred to Epic 5 but agent only wrote "noted" in conversation text — never updated sprint-status.yaml. User had to explicitly ask "are those added for sure?" to catch it. Same "looks thorough but isn't thorough" pattern. Decisions must be written to tracking files THE MOMENT they are made, not after being caught. (13) Pass 1 self-review ineffectiveness: Story 4-5 had 12 Rule 2c violations — Pass 1 claimed to audit all SQL but only caught 3 of 8 locations. Naz (Pass 2) caught 5, Murat (Pass 3) caught 1 more that BOTH passes missed. The mandatory self-check step is not being executed honestly. Same pattern: "looking thorough" vs "being thorough." Need structural enforcement (automated grep/lint) not honor-system checklists.

  # ═══════════════════════════════════════════════════════
  # Epic 5: Interactive Reporting & Feedback Loop
  # FRs: FR14-FR19, FR43, FR45
  # ═══════════════════════════════════════════════════════
  epic-5: backlog
  5-1-interactive-report-dashboard: backlog                    # Party mode 4-5 decisions: markdown rendering (markdown lib + CSS theme), collapsed/expanded per-file progress view with real-time status updates, output retrieval API consumption. Also from 4-5 Pass 1 F9: WorkflowRunResponseDto.toResponse omits templateId, templateName, workflowName fields — add these to response mapping.
  5-2-evidence-drawer-progressive-disclosure: backlog
  5-3-human-in-the-loop-feedback-multi-modal: backlog         # Party mode 4-5 decisions: HTML comment section markers (<!-- SECTION:key --> / <!-- /SECTION:key -->) for per-section parsing/regeneration. Prompts updated to include markers when per-section ops needed. Naz's recommendation.
  5-4-feedback-processing-the-re-run: backlog                  # Party mode 4-5 decisions: version management (keep all versions vs archive non-chosen), user-initiated regeneration with cost transparency, per-section regeneration UX
  5-5-pdf-export-service: backlog
  epic-5-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 6: Guest Access & Sharing
  # FRs: FR20, FR39, FR40
  # ═══════════════════════════════════════════════════════
  epic-6: backlog
  6-1-magic-link-generator-service: backlog
  6-2-guest-access-guard-middleware: backlog
  6-3-guest-report-viewer-read-only: backlog
  epic-6-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 7: Observability & Advanced Operations
  # FRs: FR29, FR31, FR38, FR49
  # ═══════════════════════════════════════════════════════
  epic-7: backlog
  7-1-llm-model-provider-management: backlog
  7-2-audit-logging-service-security: backlog
  7-3-service-status-monitor: backlog                    # Includes: /health endpoint via @nestjs/terminus (DB, Redis, BullMQ checks). Partially addresses observability gap from TEA review.
  7-4-admin-execution-inspector: backlog
  7-5-refresh-token-rotation: backlog # NFR deferred item — replaces interim 7-day JWT expiry from hardening story
  7-6-queue-health-dashboard: backlog                   # Bubble Admin queue health dashboard: waiting/active/completed/failed jobs, avg wait time, 80% saturation warning. Added from Epic 4 planning (2026-02-09).
  # 7-6-admin-settings-page: MOVED → 3.1-1 (Epic 3.1: Settings & Essentials)
  7-7-ui-polish-pass: backlog # Retro items #1, #7: Visual consistency (avatar dropdown moved to 3.1-2)
  7-8-admin-workflow-configurator-panel: backlog    # Admin view for bulk workflow management: filter by model/custom-params/obsolete-params, quick parameter editing without opening wizard, config snapshot/restore on model revert (save old custom params per workflow+model, auto-restore when reverting). Origin: 4-GP party mode (2026-02-15). Depends on 4-GP + 4-H1.
  7-9-structured-logging-correlation-ids: backlog         # Replace console.log with structured JSON logging (NestJS Pino or Winston). Add correlation IDs (request-scoped trace IDs), request context propagation. Every log line: { traceId, tenantId, userId, timestamp, level, message, ...meta }. Enables log aggregation (ELK/Loki) and cross-request debugging. Origin: TEA system-level testability review (2026-02-16).
  7-10-prometheus-metrics-basic: backlog                   # Basic Prometheus metrics: HTTP request latency histograms (p50/p95/p99), BullMQ queue depth (waiting/active/failed), active workflow runs per tenant, LLM provider response times, credit consumption rate. Expose /metrics endpoint. Enables Grafana dashboards and SLO alerting. Origin: TEA system-level testability review (2026-02-16).
  7-11-opentelemetry-distributed-tracing: backlog         # OpenTelemetry SDK integration: auto-instrument HTTP (NestJS), trace BullMQ job processing (API submit → queue → LLM call → fan-in → completion), propagate trace context across async boundaries. Export to Jaeger/GCP Cloud Trace. Vendor-neutral standard. Origin: TEA system-level testability review (2026-02-16).
  7-12-security-test-suite: backlog                        # OWASP-focused automated security tests: SQL injection (parameterized query verification), XSS sanitization (user-generated content), prompt injection prevention (FR45), CSRF validation, npm audit in CI. Origin: TEA system-level testability review (2026-02-16).
  epic-7-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 7P: Production Readiness
  # Critical infrastructure gaps identified by Architect Review (2026-02-05)
  # Must complete before production deployment
  # Can run parallel with Epics 4-6
  #
  # CONTEXT: The Architect Review Package flagged 7 critical gaps that
  # are not covered by any existing epic. These are infrastructure and
  # operational concerns that must be resolved before the product can
  # be deployed to real users. See:
  #   _bmad-output/planning-artifacts/architect-review-package.md
  #
  # NOTE: Some stories may be split further during story creation.
  # Story 7P-1 (deployment target) is a prerequisite for 7P-2, 7P-3, 7P-4.
  # ═══════════════════════════════════════════════════════
  epic-7p: backlog
  7p-1-deployment-target-dockerfiles: backlog        # Choose cloud provider, create Dockerfiles for api-gateway + web + worker-engine, define infra (managed DB, Redis, compute). MUST include: SQL migration files (replace synchronize:true), bubble_app role provisioning (CREATE ROLE + GRANT), RLS policy creation scripts.
  7p-2-cloud-file-storage-migration: backlog         # Replace local fs with GCS/S3. Swap storage backend in AssetsService. Depends on 7P-1 (cloud choice).
  7p-3-secrets-management: backlog                   # Integrate cloud secrets manager. Replace .env with GCP SM / AWS SM / Vault. Key rotation for JWT. Depends on 7P-1.
  7p-4-database-backup-disaster-recovery: backlog    # Automated pg_dump or managed DB PITR. Redis persistence config. File storage versioning. Depends on 7P-1.
  7p-5-bullmq-hardening: backlog                     # Circuit breaker for LLM providers, alerting on failures, advanced monitoring. Pre-production only (safety-critical subset moved to Epic 4 Story 4.0).
  7p-5b-worker-extraction: backlog                    # Extract BullMQ workflow execution processor to separate worker process for horizontal scaling. In-process is sufficient until scaling needed. Added from Epic 4 planning (2026-02-09).
  7p-6-rls-auth-bypass-security-review: done          # ABSORBED INTO Story 4-RLS (full RLS enablement moved to Epic 4). Non-superuser role + dual DataSource + policy audit. No longer a separate 7P story.
  7p-5c-reconcile-orphaned-runs: backlog                # Cron-based reconciliation for workflow runs stuck in RUNNING state (BullMQ worker crash recovery). Scan RUNNING > 1hr, check BullMQ queue, mark FAILED if job missing, refund credits. Moved from Epic 4 (tracked from 4-RLS-B Pass 2 MEDIUM-007).
  7p-7-load-testing-capacity-planning: backlog       # Define Year 1 targets (tenants, users, runs/day, storage). Set up k6/Artillery. Validate PRD performance NFRs (ASR-003: 2s submission, ASR-005: 200ms UI, ASR-006: 3s report). Run against staging. Also: grow API-level integration tests (currently 4% → target 15-20%) — full HTTP request → controller → guards → service → TransactionManager → real DB → response. Origin expanded from TEA review (2026-02-16).
  epic-7p-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Documentation & Onboarding (Cross-cutting)
  # Required before production: Admin handbook, user manual,
  # system description docs. These document the platform for
  # operators and end-users.
  #
  # NOTE: Story 3.9 (workflow wizard docs) is a specific story;
  # these are broader documentation deliverables that span the
  # entire product.
  # ═══════════════════════════════════════════════════════
  doc-1-admin-handbook: backlog                           # Admin's Handbook: system setup (env vars, SETTINGS_ENCRYPTION_KEY, DB config), provider credential configuration, tenant management, LLM model management, monitoring, troubleshooting. Target audience: platform operator / Bubble Admin.
  doc-2-user-manual: backlog                              # User's Manual: end-user guide for tenant admins and creators. Workflow creation, chain building, file uploads, data vault, running workflows, reading reports. Target audience: tenant users.
  doc-3-system-description: backlog                       # System Description / Architecture Overview: deployment architecture, service map, data flow, security model, API reference. For onboarding new developers or auditors.
  doc-4-operations-runbook: backlog                        # Operations Runbook: queue monitoring (BullMQ queue names, DLQ inspection), log formats (structured JSON fields), env vars (WORKER_CONCURRENCY, THROTTLE_LIMIT, REDIS_*), alerting (saturation warnings), scaling procedures, troubleshooting failed runs. Incrementally updated by each Epic 4 story. Target audience: platform operator / DevOps. Added from Story 4-0 party mode (2026-02-09).

  # ═══════════════════════════════════════════════════════
  # Epic 8: Conversational Intelligence (Future Roadmap)
  # FRs: FR52, FR53
  # ═══════════════════════════════════════════════════════
  epic-8: backlog
  8-1-chat-with-report-scoped-rag: backlog
  8-2-chat-with-company-global-rag: backlog
  epic-8-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 9: Knowledge Graph Evolution (Phase 2)
  # ═══════════════════════════════════════════════════════
  epic-9: backlog
  9-1-relational-edge-extraction: backlog
  9-2-visual-graph-explorer: backlog
  9-3-smart-ingestion-pipelines: backlog
  epic-9-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 10: Advanced Visual Definition (Future MVP v2)
  # ═══════════════════════════════════════════════════════
  epic-10: backlog
  10-1-visual-graph-canvas: backlog
  10-2-visual-cycle-detection: backlog
  epic-10-retrospective: optional

  # ═══════════════════════════════════════════════════════
  # Epic 11: Plan Tier Management & Template System (Future)
  # Dependencies: Epic 1
  # ═══════════════════════════════════════════════════════
  epic-11: backlog
  11-1-tier-definition-crud: backlog
  11-2-tier-to-tenant-auto-apply: backlog
  11-3-per-tenant-override: backlog
  epic-11-retrospective: optional
