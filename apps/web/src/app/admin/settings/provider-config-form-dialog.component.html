<div
  class="dialog-backdrop"
  data-testid="provider-form-dialog-backdrop"
  role="presentation"
  (click)="onCancel()"
  (keydown.escape)="onCancel()"
>
  <div
    class="dialog"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="'provider-dialog-title'"
    data-testid="provider-form-dialog"
    (click)="$event.stopPropagation()"
    (keydown)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="dialog-header">
      <h2 id="provider-dialog-title" class="dialog-title">{{ dialogTitle() }}</h2>
      <button
        type="button"
        class="close-btn"
        aria-label="Close dialog"
        data-testid="dialog-close-btn"
        (click)="onCancel()"
      >
        <lucide-icon name="x" [size]="18"></lucide-icon>
      </button>
    </div>

    <!-- Error banner -->
    @if (error()) {
      <div class="error-banner" data-testid="form-error">
        <lucide-icon name="alert-circle" [size]="16"></lucide-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dialog-form">
      <!-- Provider Key -->
      <div class="form-group">
        <label for="providerKey">
          Provider Key <span class="required">*</span>
        </label>
        @if (isEditMode()) {
          <input
            type="text"
            id="providerKey"
            formControlName="providerKey"
            class="form-input readonly"
            data-testid="input-providerKey"
            readonly
          />
          <span class="field-hint">Provider key cannot be changed after creation</span>
        } @else {
          <select
            id="providerKey"
            formControlName="providerKey"
            class="form-select"
            [class.error]="hasError('providerKey')"
            data-testid="input-providerKey"
            (change)="onProviderKeyChange($event)"
          >
            <option value="">Select a provider</option>
            @for (opt of providerOptions; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
          @if (hasError('providerKey')) {
            <span class="field-error">{{ getFieldError('providerKey') }}</span>
          }
        }
      </div>

      <!-- Display Name -->
      <div class="form-group">
        <label for="displayName">
          Display Name <span class="required">*</span>
        </label>
        <input
          type="text"
          id="displayName"
          formControlName="displayName"
          placeholder="e.g. Google AI Studio"
          class="form-input"
          [class.error]="hasError('displayName')"
          data-testid="input-displayName"
        />
        @if (hasError('displayName')) {
          <span class="field-error">{{ getFieldError('displayName') }}</span>
        }
      </div>

      <!-- Dynamic credential fields -->
      @if (credentialFields().length > 0) {
        <div class="credentials-section">
          <h3 class="section-title">
            <lucide-icon name="key" [size]="14"></lucide-icon>
            Credentials
          </h3>
          @if (isEditMode()) {
            <p class="section-hint">Leave fields empty to keep existing credentials unchanged.</p>
          }

          @for (field of credentialFields(); track field.key) {
            <div class="form-group">
              <label [for]="'cred-' + field.key">
                {{ field.label }}
                @if (field.required && !isEditMode()) {
                  <span class="required">*</span>
                }
              </label>
              @if (field.key === 'serviceAccountJson') {
                <textarea
                  [id]="'cred-' + field.key"
                  [placeholder]="field.placeholder"
                  class="form-input form-textarea"
                  [attr.data-testid]="'input-cred-' + field.key"
                  rows="3"
                  (input)="onCredentialChange(field.key, $event)"
                ></textarea>
              } @else {
                <input
                  type="password"
                  [id]="'cred-' + field.key"
                  [placeholder]="field.placeholder"
                  class="form-input"
                  [attr.data-testid]="'input-cred-' + field.key"
                  (input)="onCredentialChange(field.key, $event)"
                />
              }
            </div>
          }
        </div>
      }

      @if (selectedProviderKey() === 'mock') {
        <div class="info-banner">
          <lucide-icon name="info" [size]="14"></lucide-icon>
          <span>Mock provider requires no credentials.</span>
        </div>
      }

      <!-- Active checkbox -->
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input
            type="checkbox"
            formControlName="isActive"
            data-testid="input-isActive"
          />
          <span class="checkbox-text">Active</span>
        </label>
        <span class="field-hint">Inactive providers won't be available for workflow execution</span>
      </div>

      <!-- Actions -->
      <div class="dialog-actions">
        <button
          type="button"
          class="btn btn-secondary"
          data-testid="cancel-btn"
          (click)="onCancel()"
          [disabled]="submitting()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          data-testid="submit-btn"
          [disabled]="submitting()"
        >
          @if (submitting()) {
            <lucide-icon name="loader-2" [size]="16" class="spinner"></lucide-icon>
            Saving...
          } @else {
            {{ isEditMode() ? 'Save Changes' : 'Add Provider' }}
          }
        </button>
      </div>
    </form>
  </div>
</div>
