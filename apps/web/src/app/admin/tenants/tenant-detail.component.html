@if (loading()) {
  <div class="loading-state">Loading tenant...</div>
} @else if (tenant(); as t) {
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a routerLink="/admin/tenants" class="breadcrumb-link">
      <lucide-icon name="arrow-left" [size]="16"></lucide-icon>
      Tenants
    </a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ t.name }}</span>
  </div>

  <!-- Header Card -->
  <div class="header-card">
    <div class="header-info">
      <div class="header-title-row">
        <h1 class="tenant-name">{{ t.name }}</h1>
        <app-status-badge [status]="t.status" data-testid="tenant-status-badge"></app-status-badge>
      </div>
      <div class="header-meta">
        <span>Created: {{ t.createdAt | date:'mediumDate' }}</span>
        <span class="meta-separator">&bull;</span>
        <span>Tier: {{ t.planTier | titlecase }}</span>
        <span class="meta-separator">&bull;</span>
        <span>Users: {{ users().length === 0 ? '—' : users().length }}</span>
      </div>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-danger-outline"
        (click)="openImpersonateDialog()"
        [disabled]="impersonating() || t.status === 'suspended' || t.status === 'archived'"
        data-testid="impersonate-btn"
      >
        <lucide-icon name="alert-triangle" [size]="16"></lucide-icon>
        Impersonate
      </button>
      @if (t.status === 'active' || t.status === 'suspended') {
        <button
          class="btn btn-outline"
          [class.btn-danger-outline]="t.status === 'active'"
          (click)="openSuspendDialog()"
          [disabled]="saving()"
          data-testid="suspend-toggle-btn"
        >
          {{ t.status === 'active' ? 'Suspend' : 'Activate' }}
        </button>
      }
      @if (t.status === 'archived') {
        <button
          class="btn btn-outline"
          (click)="confirmUnarchive()"
          [disabled]="archiving()"
          data-testid="unarchive-btn"
          title="Restore this tenant to active status"
        >
          {{ archiving() ? 'Restoring...' : 'Unarchive' }}
        </button>
      } @else {
        <button
          class="btn btn-outline"
          (click)="openArchiveDialog()"
          [disabled]="archiving() || saving()"
          data-testid="archive-btn"
          title="Archive this tenant. Users will lose access. Data is preserved and can be restored."
        >
          <lucide-icon name="archive" [size]="16"></lucide-icon>
          Archive
        </button>
      }
      @if (t.status === 'archived') {
        <button
          class="btn btn-danger"
          (click)="openDeleteDialog()"
          [disabled]="deleting()"
          data-testid="delete-btn"
          title="Permanently delete this tenant and all data. This cannot be undone."
        >
          <lucide-icon name="trash-2" [size]="16"></lucide-icon>
          {{ deleting() ? 'Deleting...' : 'Delete' }}
        </button>
      }
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    @for (tab of tabs; track tab.key) {
      <button
        class="tab-btn"
        [class.active]="activeTab() === tab.key"
        [disabled]="tab.key !== 'general' && tab.key !== 'entitlements' && tab.key !== 'users'"
        (click)="setTab(tab.key)"
        [attr.data-testid]="'tab-' + tab.key"
      >
        {{ tab.label }}
      </button>
    }
  </div>

  <!-- Tab Content -->
  @if (activeTab() === 'general') {
    <div class="tab-content">
      <div class="form-card">
        <div class="form-group">
          <label class="form-label" for="tenant-name">Tenant Name</label>
          <input
            id="tenant-name"
            class="form-input"
            type="text"
            [value]="editName()"
            (input)="editName.set($any($event.target).value)"
            data-testid="tenant-name-input"
          />
        </div>
        <div class="form-group">
          <label class="form-label" for="tenant-id">Tenant ID</label>
          <div class="id-field">
            <input id="tenant-id" class="form-input id-input" type="text" [value]="t.id" readonly />
            <button class="btn btn-sm btn-outline copy-btn" (click)="copyTenantId()">
              <lucide-icon name="copy" [size]="14"></lucide-icon>
              {{ copiedId() ? 'Copied!' : 'Copy' }}
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="tenant-created">Created</label>
          <input id="tenant-created" class="form-input" type="text" [value]="t.createdAt | date:'medium'" readonly />
        </div>
        <div class="form-group">
          <label class="form-label" for="tenant-contact">Primary Contact</label>
          <input
            id="tenant-contact"
            class="form-input"
            type="text"
            placeholder="Enter primary contact email"
            [value]="editContact()"
            (input)="editContact.set($any($event.target).value)"
          />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="tenant-plan">
              Plan Tier
              <span class="label-hint" title="Tier is currently a label only. Usage limits (runs, retention) are configured manually per tenant in the Entitlements tab. A tier management system to define what each tier includes is planned for a future release.">
                <lucide-icon name="info" [size]="14"></lucide-icon>
              </span>
            </label>
            <select
              id="tenant-plan"
              class="form-select"
              [value]="editPlanTier()"
              (change)="editPlanTier.set($any($event.target).value)"
            >
              @for (opt of planTierOptions; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
            <span class="form-hint">Limits are set manually per tenant in the Entitlements tab.</span>
          </div>
          <div class="form-group">
            <label class="form-label" for="tenant-residency">
              Data Residency
              <span class="label-hint" title="For the MVP, all tenants are hosted in the EU (Frankfurt/Dublin) regardless of this setting. Regional routing will be available in a future release.">
                <lucide-icon name="info" [size]="14"></lucide-icon>
              </span>
            </label>
            <select
              id="tenant-residency"
              class="form-select"
              [value]="editResidency()"
              (change)="editResidency.set($any($event.target).value)"
            >
              @for (opt of residencyOptions; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
            <span class="form-hint">All data is currently processed in EU (Frankfurt/Dublin).</span>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-outline" [disabled]="!isGeneralDirty()" (click)="cancelGeneral()">Cancel</button>
          <button class="btn btn-primary" [disabled]="!isGeneralDirty() || saving()" (click)="saveGeneral()" data-testid="tenant-save-btn">
            {{ saving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  } @else if (activeTab() === 'entitlements') {
    <div class="tab-content">
      <!-- Run Quota Section -->
      <div class="form-card entitlements-section">
        <h3 class="section-title">Run Quota</h3>
        <div class="form-group">
          <label class="form-label" for="max-runs">Max Monthly Runs</label>
          <input
            id="max-runs"
            class="form-input number-input"
            type="number"
            min="0"
            [value]="editMaxRuns()"
            (input)="onMaxRunsInput($event)"
          />
        </div>
        <div class="form-group">
          <label class="form-label" for="current-usage">Current Usage</label>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width]="'0%'"></div>
            </div>
            <span id="current-usage" class="progress-text">0 / {{ editMaxRuns() }} (0%)</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="reset-date">Reset Date</label>
          <input id="reset-date" class="form-input" type="text" [value]="resetDate() | date:'mediumDate'" readonly />
        </div>
      </div>

      <!-- Asset Retention Section -->
      <div class="form-card entitlements-section">
        <h3 class="section-title">Asset Retention</h3>
        <div class="form-group">
          <label class="form-label" for="retention-days">Retention Days</label>
          <input
            id="retention-days"
            class="form-input number-input"
            type="number"
            min="1"
            max="365"
            [value]="editRetentionDays()"
            (input)="onRetentionDaysInput($event)"
          />
          <span class="form-helper">Soft-deleted files are purged after this period</span>
        </div>
      </div>

      <!-- Workflow Access Placeholder -->
      <div class="form-card entitlements-section">
        <h3 class="section-title">Workflow Access</h3>
        <div class="info-box">
          <p>Workflow access is managed per-workflow from Workflow Studio. Public workflows are available to all tenants.</p>
          <a routerLink="/admin/workflows" class="btn btn-outline btn-sm">Go to Workflow Studio</a>
        </div>
      </div>

      <!-- Entitlements Save/Cancel -->
      <div class="form-card">
        <div class="form-actions">
          <button class="btn btn-outline" [disabled]="!isEntitlementsDirty()" (click)="cancelEntitlements()">Cancel</button>
          <button class="btn btn-primary" [disabled]="!isEntitlementsDirty() || saving()" (click)="saveEntitlements()">
            {{ saving() ? 'Saving...' : 'Save Entitlements' }}
          </button>
        </div>
      </div>
    </div>
  } @else if (activeTab() === 'users') {
    <div class="tab-content">
      <!-- Users Section -->
      <div class="form-card users-section">
        <h3 class="section-title">Users</h3>

        @if (loadingUsers()) {
          <div class="loading-state">Loading users...</div>
        } @else if (users().length === 0) {
          <div class="empty-state">
            <p>No users in this tenant yet.</p>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table" data-testid="users-table">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                @for (user of users(); track user.id) {
                  <tr [attr.data-testid]="'user-row-' + user.id">
                    <td>{{ user.email }}</td>
                    <td>{{ user.name ?? '—' }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                      <span
                        class="status-badge"
                        [class.status-accepted]="user.status === 'active'"
                        [class.status-revoked]="user.status === 'deactivated'"
                      >
                        {{ user.status }}
                      </span>
                    </td>
                    <td>{{ user.createdAt | date:'mediumDate' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Invitations Section -->
      <div class="form-card">
        <div class="users-header">
          <h3 class="section-title">Invitations</h3>
          <button class="btn btn-primary btn-sm" (click)="openInviteDialog()" data-testid="invite-user-btn">
            <lucide-icon name="user-plus" [size]="16"></lucide-icon>
            Invite User
          </button>
        </div>

        @if (loadingInvitations()) {
          <div class="loading-state">Loading invitations...</div>
        } @else if (invitations().length === 0) {
          <div class="empty-state">
            <p>No invitations yet. Click "Invite User" to get started.</p>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Invited</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (inv of invitations(); track inv.id) {
                  <tr [attr.data-testid]="'invitation-row-' + inv.id">
                    <td>{{ inv.email }}</td>
                    <td>{{ inv.role }}</td>
                    <td>
                      <span
                        class="status-badge"
                        [class.status-pending]="inv.status === 'pending'"
                        [class.status-accepted]="inv.status === 'accepted'"
                        [class.status-expired]="inv.status === 'expired'"
                        [class.status-revoked]="inv.status === 'revoked'"
                        [attr.data-testid]="'invitation-status-' + inv.id"
                      >
                        {{ inv.status }}
                      </span>
                    </td>
                    <td>{{ inv.createdAt | date:'mediumDate' }}</td>
                    <td>{{ inv.expiresAt | date:'mediumDate' }}</td>
                    <td>
                      @if (inv.status === 'pending') {
                        <button class="btn btn-sm btn-outline" (click)="resendInvitation(inv.id)" title="Resend">
                          <lucide-icon name="refresh-cw" [size]="14"></lucide-icon>
                        </button>
                        <button class="btn btn-sm btn-danger-outline" (click)="revokeInvitation(inv.id)" title="Revoke" [attr.data-testid]="'invitation-revoke-' + inv.id">
                          <lucide-icon name="x-circle" [size]="14"></lucide-icon>
                        </button>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  } @else {
    <div class="tab-content">
      <div class="placeholder-content">
        <p>{{ activeTab() | titlecase }} tab — coming in a future story.</p>
      </div>
    </div>
  }

  <!-- Invite User Dialog -->
  @if (showInviteDialog()) {
    <app-invite-user-dialog
      [tenantId]="t.id"
      (closed)="closeInviteDialog()"
      (invited)="onInviteSent()"
    ></app-invite-user-dialog>
  }

  <!-- Impersonate Confirmation Dialog -->
  @if (showImpersonateDialog()) {
    <app-impersonate-confirm-dialog
      [tenantName]="t.name"
      (confirmed)="onConfirmImpersonate()"
      (cancelled)="closeImpersonateDialog()"
    ></app-impersonate-confirm-dialog>
  }

  <!-- Suspend/Activate Confirmation Dialog -->
  @if (showSuspendDialog()) {
    <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events -->
    <div class="dialog-overlay" (click)="closeSuspendDialog()" role="dialog" aria-modal="true" data-testid="suspend-confirm-dialog">
      <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
      <div class="dialog-card" (click)="$event.stopPropagation()">
        <h2 class="dialog-title">
          {{ t.status === 'active' ? 'Suspend' : 'Activate' }} {{ t.name }}?
        </h2>
        <p class="dialog-text">
          @if (t.status === 'active') {
            Users will lose access. This can be reversed.
          } @else {
            Users will regain access.
          }
        </p>
        <div class="dialog-actions">
          <button class="btn btn-outline" (click)="closeSuspendDialog()">Cancel</button>
          <button
            class="btn"
            [class.btn-danger]="t.status === 'active'"
            [class.btn-primary]="t.status !== 'active'"
            (click)="confirmSuspendToggle()"
            data-testid="suspend-confirm-btn"
          >
            {{ t.status === 'active' ? 'Suspend' : 'Activate' }}
          </button>
        </div>
      </div>
    </div>
  }
  <!-- Archive Confirmation Dialog -->
  @if (showArchiveDialog()) {
    <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events -->
    <div class="dialog-overlay" (click)="closeArchiveDialog()" role="dialog" aria-modal="true" data-testid="archive-confirm-dialog">
      <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
      <div class="dialog-card" (click)="$event.stopPropagation()">
        <h2 class="dialog-title">Archive {{ t.name }}?</h2>
        <p class="dialog-text">
          Users will lose access immediately. All data is preserved and the tenant can be restored later.
        </p>
        <div class="dialog-actions">
          <button class="btn btn-outline" (click)="closeArchiveDialog()" data-testid="archive-cancel-btn">Cancel</button>
          <button class="btn btn-danger" (click)="confirmArchive()" data-testid="archive-confirm-btn">
            Archive
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Delete Confirmation Dialog -->
  @if (showDeleteDialog()) {
    <app-delete-confirm-dialog
      [tenantName]="t.name"
      (confirmed)="confirmDelete()"
      (cancelled)="closeDeleteDialog()"
    ></app-delete-confirm-dialog>
  }
} @else {
  <div class="loading-state">Tenant not found.</div>
}
