<div class="step-section">
  <h2 class="step-title">Execution Config</h2>
  <p class="step-description">Configure how the LLM processes your workflow.</p>

  <form [formGroup]="form" class="form-fields">
    <div class="form-group">
      <span class="field-label">
        Processing Mode
        <app-info-tooltip text="Parallel: each subject file processed independently. Batch: all files in one LLM call." />
      </span>
      <div class="radio-group">
        <label class="radio-item">
          <input type="radio" formControlName="processing" value="parallel" data-testid="exec-processing-parallel" />
          Parallel
          <app-info-tooltip text="Each subject file is processed independently in its own LLM call" />
        </label>
        <label class="radio-item">
          <input type="radio" formControlName="processing" value="batch" data-testid="exec-processing-batch" />
          Batch
          <app-info-tooltip text="All subject files are combined into a single LLM call" />
        </label>
      </div>
    </div>

    <div class="form-group">
      <span class="field-label">
        LLM Model <span class="required">*</span>
        <app-info-tooltip text="The AI model to use for this workflow. Different models vary in speed, cost, and capability." />
      </span>
      @if (modelsLoading()) {
        <span class="field-hint">Loading models...</span>
      }
      @if (modelsLoadError()) {
        <span class="field-error" data-testid="models-load-error">{{ modelsLoadError() }}</span>
      }
      <select formControlName="model" data-testid="exec-model-select">
        <option value="">Select a model</option>
        @for (model of models(); track model.id) {
          <option [value]="model.id">{{ model.displayName }}</option>
        }
      </select>
      @if (form.get('model')?.touched && form.get('model')?.hasError('required')) {
        <span class="field-error">Model is required</span>
      }
      @if (resetNotification()) {
        <span class="field-hint" data-testid="exec-reset-notification">
          {{ resetNotification() }}
        </span>
      }
    </div>

    <!-- Dynamic Generation Parameters (Basic) -->
    @if (basicParams().length > 0) {
      <div class="form-row" [formGroup]="generationParamsForm" data-testid="exec-basic-params">
        @for (param of basicParams(); track param.key) {
          <div class="form-group">
            <span class="field-label">{{ param.label }}</span>
            <input
              type="number"
              [formControlName]="param.key"
              [placeholder]="getResolvedDefault(param)"
              [min]="param.min ?? ''"
              [max]="param.max ?? ''"
              [step]="param.max !== undefined && param.max <= 2 ? 0.01 : 1"
              [attr.data-testid]="'exec-param-' + param.key"
            />
            @if (getResolvedDefault(param)) {
              <span class="field-hint">Leave empty to use model default ({{ getResolvedDefault(param) }})</span>
            }
            @if (hasGenerationParamError(param.key)) {
              <span class="field-error">{{ getGenerationParamError(param.key) }}</span>
            }
          </div>
        }
      </div>
    }

    <!-- Advanced Generation Parameters (collapsible) -->
    @if (advancedParams().length > 0) {
      <details [open]="advancedOpen()" data-testid="exec-advanced-section" class="advanced-section">
        <summary (click)="toggleAdvanced(); $event.preventDefault()" class="advanced-summary" data-testid="exec-advanced-toggle">
          <lucide-icon [name]="advancedOpen() ? 'chevron-up' : 'chevron-down'" [size]="16"></lucide-icon>
          Advanced Parameters
        </summary>
        <div class="form-row" [formGroup]="generationParamsForm">
          @for (param of advancedParams(); track param.key) {
            <div class="form-group">
              <span class="field-label">{{ param.label }}</span>
              <input
                type="number"
                [formControlName]="param.key"
                [placeholder]="getResolvedDefault(param)"
                [min]="param.min ?? ''"
                [max]="param.max ?? ''"
                [step]="param.max !== undefined && param.max <= 2 ? 0.01 : 1"
                [attr.data-testid]="'exec-param-' + param.key"
              />
              @if (getResolvedDefault(param)) {
                <span class="field-hint">Leave empty to use model default ({{ getResolvedDefault(param) }})</span>
              }
              @if (hasGenerationParamError(param.key)) {
                <span class="field-error">{{ getGenerationParamError(param.key) }}</span>
              }
            </div>
          }
        </div>
      </details>
    }

    <!-- Reset to defaults button -->
    @if (basicParams().length > 0 || advancedParams().length > 0) {
      <div class="form-group reset-defaults-row">
        <button
          type="button"
          class="btn btn-secondary btn-sm"
          data-testid="exec-reset-defaults-btn"
          (click)="onResetToDefaults()"
        >
          <lucide-icon name="rotate-ccw" [size]="14"></lucide-icon>
          Reset to defaults
        </button>
      </div>
    }

    <div class="form-group">
      <span class="field-label">
        Max Retries
        <app-info-tooltip text="How many times to retry if LLM output fails structural validation. Overrides system default" />
      </span>
      <input
        type="number"
        formControlName="max_retries"
        min="0"
        max="10"
        placeholder="System default"
        data-testid="exec-max-retries-input"
      />
      <span class="field-hint">Leave empty to use system default</span>
    </div>
  </form>
</div>
