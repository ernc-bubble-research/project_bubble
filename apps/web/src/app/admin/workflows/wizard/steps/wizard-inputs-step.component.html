<div class="step-section">
  <h2 class="step-title">Inputs</h2>
  <p class="step-description">Define the data inputs your workflow expects at runtime.</p>

  @if (subjectError()) {
    <div class="inline-error" data-testid="subject-error">
      <lucide-icon name="alert-circle" [size]="14"></lucide-icon>
      {{ subjectError() }}
    </div>
  }

  @if (duplicateNames().length > 0) {
    <div class="inline-error" style="margin-top: 8px" data-testid="duplicate-name-error">
      <lucide-icon name="alert-circle" [size]="14"></lucide-icon>
      Duplicate input names: {{ duplicateNames().join(', ') }}
    </div>
  }

  @if (sourceError()) {
    <div class="inline-error" style="margin-top: 8px" data-testid="source-error">
      <lucide-icon name="alert-circle" [size]="14"></lucide-icon>
      {{ sourceError() }}
    </div>
  }

  <form [formGroup]="form">
    <div formArrayName="inputs" class="form-fields" style="margin-top: 16px">
      @for (ctrl of inputsArray.controls; track ctrl; let i = $index) {
        <div
          class="card"
          [class.collapsed]="isCollapsed(i)"
          [attr.data-testid]="'input-card-' + i"
        >
          <div class="card-header" role="button" [attr.aria-expanded]="!isCollapsed(i)" (click)="toggleCollapse(i)" (keydown.enter)="toggleCollapse(i)" tabindex="0">
            <span class="card-title">
              {{ inputsArray.at(i).get('name')?.value || 'New Input' }}
              @if (inputsArray.at(i).get('role')?.value === 'subject') {
                <span class="chip chip-success" style="margin-left: 8px">subject</span>
              }
            </span>
            <div class="card-actions">
              <button
                type="button"
                class="icon-btn danger"
                [attr.data-testid]="'remove-input-' + i"
                (click)="removeInput(i); $event.stopPropagation()"
              >
                <lucide-icon name="trash-2" [size]="14"></lucide-icon>
              </button>
              <lucide-icon
                [name]="isCollapsed(i) ? 'chevron-down' : 'chevron-up'"
                [size]="16"
              ></lucide-icon>
            </div>
          </div>

          @if (!isCollapsed(i)) {
            <div [formGroupName]="i" class="form-fields" style="margin-top: 16px">
              <div class="form-row">
                <div class="form-group">
                  <span class="field-label">
                    Name <span class="required">*</span>
                    <app-info-tooltip text="Variable name used in prompts via {name}. Use snake_case (e.g., subject, research_brief)." />
                  </span>
                  <input
                    type="text"
                    formControlName="name"
                    placeholder="e.g., transcripts"
                    [attr.data-testid]="'input-name-' + i"
                  />
                </div>
                <div class="form-group">
                  <span class="field-label">
                    Label <span class="required">*</span>
                    <app-info-tooltip text="Human-readable label shown to users when filling out the run form." />
                  </span>
                  <input
                    type="text"
                    formControlName="label"
                    placeholder="e.g., Interview Transcripts"
                    [attr.data-testid]="'input-label-' + i"
                  />
                </div>
              </div>

              <div class="form-group">
                <span class="field-label">
                  Description
                  <app-info-tooltip text="Help text shown below the input field at runtime. Explain what content to provide." />
                </span>
                <textarea
                  formControlName="description"
                  rows="2"
                  placeholder="Help text shown to the user at runtime..."
                  [attr.data-testid]="'input-description-' + i"
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <span class="field-label">
                    Role
                    <app-info-tooltip text="Subject: the primary files being analyzed (exactly 1 required). Context: shared reference material included in every LLM call." />
                  </span>
                  <select formControlName="role" [attr.data-testid]="'input-role-' + i">
                    <option value="context">Context</option>
                    <option value="subject">Subject</option>
                  </select>
                </div>
                <div class="form-group">
                  <span class="field-label">
                    Required
                    <app-info-tooltip text="When enabled, users must provide this input before running the workflow." />
                  </span>
                  <div class="toggle-group">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        formControlName="required"
                        [attr.data-testid]="'input-required-' + i"
                      />
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">
                      {{ inputsArray.at(i).get('required')?.value ? 'Yes' : 'No' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <span class="field-label">
                Source Types
                <app-info-tooltip text="How the user provides this input at runtime" />
              </span>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" formControlName="source_asset" [attr.data-testid]="'input-source-asset-' + i" />
                    Asset
                    <app-info-tooltip text="User selects an existing file from the Data Vault" />
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" formControlName="source_upload" [attr.data-testid]="'input-source-upload-' + i" />
                    Upload
                    <app-info-tooltip text="User uploads a new file at runtime" />
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" formControlName="source_text" [attr.data-testid]="'input-source-text-' + i" />
                    Text
                    <app-info-tooltip text="User types free-form text at runtime" />
                  </label>
                </div>
              </div>

              <!-- Conditional: File restrictions -->
              @if (hasFileSource(i)) {
                <div class="form-row">
                  <div class="form-group">
                    <span class="field-label">Allowed Extensions</span>
                    <input
                      type="text"
                      formControlName="accept_extensions"
                      placeholder=".pdf, .docx, .txt"
                      [attr.data-testid]="'input-extensions-' + i"
                    />
                    <span class="field-hint">Comma-separated, e.g., .pdf, .docx</span>
                  </div>
                  <div class="form-group">
                    <span class="field-label">Max File Size (MB)</span>
                    <input
                      type="number"
                      formControlName="accept_max_size_mb"
                      placeholder="50"
                      min="1"
                      [attr.data-testid]="'input-max-size-' + i"
                    />
                  </div>
                </div>
              }

              <!-- Conditional: Text config -->
              @if (hasTextSource(i)) {
                <div class="form-row">
                  <div class="form-group">
                    <span class="field-label">Text Placeholder</span>
                    <input
                      type="text"
                      formControlName="text_placeholder"
                      placeholder="Enter your text here..."
                      [attr.data-testid]="'input-text-placeholder-' + i"
                    />
                  </div>
                  <div class="form-group">
                    <span class="field-label">Max Text Length</span>
                    <input
                      type="number"
                      formControlName="text_max_length"
                      placeholder="5000"
                      min="1"
                      [attr.data-testid]="'input-text-maxlength-' + i"
                    />
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </form>

  <button
    type="button"
    class="btn btn-outline"
    style="margin-top: 16px"
    data-testid="add-input-btn"
    (click)="addInput()"
  >
    <lucide-icon name="plus" [size]="16"></lucide-icon>
    Add Input
  </button>
</div>
