generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  assets    Asset[]
  workflows Workflow[]

  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  tenantId  String   @map("tenant_id")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("users")
}

model Asset {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  originalName  String   @map("original_name")
  storagePath   String   @map("storage_path") // S3 key
  extractedText String?  @db.Text @map("extracted_text")
  mimeType      String   @map("mime_type")
  sizeBytes     Int      @map("size_bytes")
  
  // Vector Embedding (1536 dim for Gemini/OpenAI - adjust as needed)
  embedding     Unsupported("vector(1536)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("assets")
}

model Workflow {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  description     String?
  currentVersionId String?  @map("current_version_id")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  versions        WorkflowVersion[]
  runs            WorkflowRun[]

  @@map("workflows")
}

model WorkflowVersion {
  id         String   @id @default(uuid())
  workflowId String   @map("workflow_id")
  version    Int
  graphJson  Json     @map("graph_json") // Definition of Nodes/Edges/Inputs
  createdAt  DateTime @default(now())

  workflow Workflow @relation(fields: [workflowId], references: [id])
  runs     WorkflowRun[]

  @@map("workflow_versions")
}

model WorkflowRun {
  id                String   @id @default(uuid())
  workflowId        String   @map("workflow_id")
  workflowVersionId String   @map("workflow_version_id") // Locked version
  status            String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  resultJson        Json?    @map("result_json")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  workflow        Workflow        @relation(fields: [workflowId], references: [id])
  workflowVersion WorkflowVersion @relation(fields: [workflowVersionId], references: [id])

  @@map("workflow_runs")
}
